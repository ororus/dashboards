<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tradyom Journal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --bg:#000;--s1:rgba(255,255,255,0.04);--s2:rgba(255,255,255,0.07);
    --brd:rgba(255,255,255,0.08);--brd2:rgba(255,255,255,0.12);
    --txt:#f5f5f7;--dim:rgba(255,255,255,0.55);--mut:rgba(255,255,255,0.3);
    --grn:#34d399;--red:#f87171;--cyn:#67e8f9;--gld:#fbbf24;--pur:#c084fc;--blu:#60a5fa;--org:#fb923c;
    --grn-bg:rgba(52,211,153,0.1);--red-bg:rgba(248,113,113,0.1);
    --glass:rgba(20,20,20,0.75);--radius:16px;--radius-sm:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;-webkit-font-smoothing:antialiased;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 50% at 30% 0%,rgba(52,211,153,0.04),transparent 60%),radial-gradient(ellipse 50% 40% at 70% 100%,rgba(103,232,249,0.03),transparent 60%);pointer-events:none;}
.app{max-width:1320px;margin:0 auto;padding:20px 24px 100px;position:relative;z-index:1;}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 0 20px;margin-bottom:20px;}
.logo{font-size:1.5rem;font-weight:800;letter-spacing:-0.5px;}.logo span{color:var(--grn);}
.hdr-right{display:flex;align-items:center;gap:10px;}
.add-top-btn{padding:8px 18px;background:var(--grn);color:#000;border:none;border-radius:24px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
.add-top-btn:hover{opacity:0.9;transform:translateY(-1px);}

/* Segmented Control */
.seg-ctrl{display:flex;background:var(--s1);border:1px solid var(--brd);border-radius:12px;padding:3px;gap:2px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.seg-btn{padding:8px 18px;border:none;background:transparent;color:var(--dim);font-size:13px;font-family:inherit;font-weight:500;cursor:pointer;border-radius:10px;transition:all 0.25s;white-space:nowrap;}
.seg-btn:hover{color:var(--txt);}.seg-btn.on{background:rgba(255,255,255,0.1);color:#fff;font-weight:600;backdrop-filter:blur(10px);}

/* Glass Cards */
.card{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--brd);border-radius:var(--radius);padding:20px;transition:all 0.3s;}
.card:hover{border-color:var(--brd2);}.card-title{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin-bottom:14px;}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.stat{text-align:center;padding:18px 12px;}.stat .val{font-size:1.6rem;font-weight:700;font-family:'JetBrains Mono';margin:6px 0 4px;letter-spacing:-0.5px;}.stat .lbl{font-size:11px;color:var(--mut);font-weight:500;}

/* Panels */
.pnl{display:none;}.pnl.on{display:block;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Layout */
.row2{display:grid;grid-template-columns:1.5fr 1fr;gap:14px;margin-bottom:16px;}

/* Table */
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{font-size:10px;letter-spacing:0.5px;color:var(--mut);text-transform:uppercase;padding:10px 12px;text-align:left;border-bottom:1px solid var(--brd);cursor:pointer;white-space:nowrap;user-select:none;font-weight:600;}
th:hover{color:var(--cyn);}
td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.03);white-space:nowrap;}
tr{transition:background 0.15s;}tr:hover td{background:rgba(255,255,255,0.02);}
.pill{display:inline-block;padding:2px 10px;border-radius:20px;font-size:10px;font-weight:500;}
.pill-tag{background:rgba(192,132,252,0.1);color:var(--pur);}
.pill-cls{font-size:9px;padding:2px 8px;border-radius:12px;}
.dir-long{color:var(--grn);font-weight:600;}.dir-short{color:var(--red);font-weight:600;}

/* Filters */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.flt{padding:8px 14px;background:var(--s1);border:1px solid var(--brd);border-radius:var(--radius-sm);color:var(--dim);font-size:13px;font-family:inherit;outline:none;transition:all 0.2s;}
.flt:focus{border-color:var(--grn);color:var(--txt);}select.flt{cursor:pointer;}

/* FAB */
.fab{position:fixed;bottom:28px;right:28px;width:56px;height:56px;border-radius:50%;background:var(--grn);color:#000;border:none;font-size:28px;font-weight:300;cursor:pointer;box-shadow:0 4px 24px rgba(52,211,153,0.3);z-index:100;transition:all 0.3s;display:flex;align-items:center;justify-content:center;}
.fab:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(52,211,153,0.4);}.fab:active{transform:scale(0.95);}

/* Sheet / Modal */
.sheet-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;}
.sheet-bg.show{display:flex;}
.sheet{background:#111;border:1px solid var(--brd2);border-radius:20px;padding:32px;width:90%;max-width:580px;max-height:90vh;overflow-y:auto;position:relative;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);}
@keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
.sheet-close{position:absolute;top:16px;right:16px;background:var(--s2);border:none;color:var(--dim);width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;}
.sheet-close:hover{background:var(--brd2);color:var(--txt);}
.sheet h2{font-size:1.3rem;font-weight:700;margin-bottom:4px;letter-spacing:-0.3px;}.sheet .sub{font-size:13px;color:var(--dim);margin-bottom:24px;}

/* Form */
.fg{margin-bottom:16px;}.fg label{display:block;font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;}
.fg input,.fg select,.fg textarea{width:100%;padding:12px 16px;background:var(--s1);border:1px solid var(--brd);border-radius:var(--radius-sm);color:var(--txt);font-size:15px;font-family:inherit;outline:none;transition:all 0.2s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--grn);background:var(--s2);}
.fg textarea{resize:vertical;min-height:60px;}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}.fg-row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;}
.fg .hint{font-size:10px;color:var(--mut);margin-top:4px;}

/* Asset Class Selector */
.ac-sel{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:18px;}
.ac-opt{padding:10px 6px;border:2px solid var(--brd);border-radius:var(--radius-sm);background:transparent;color:var(--dim);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;}
.ac-opt .ac-icon{font-size:18px;}
.ac-opt:hover{border-color:var(--brd2);color:var(--txt);}
.ac-opt.sel{border-color:var(--grn);color:var(--grn);background:var(--grn-bg);}

/* Direction Buttons */
.dir-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.dir-btn{padding:14px;border:2px solid var(--brd);border-radius:var(--radius-sm);background:transparent;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.25s;}
.dir-btn.long{color:var(--grn);}.dir-btn.short{color:var(--red);}
.dir-btn.long.sel{background:var(--grn-bg);border-color:var(--grn);}.dir-btn.short.sel{background:var(--red-bg);border-color:var(--red);}
.dir-btn.buy{color:var(--grn);}.dir-btn.sell{color:var(--red);}
.dir-btn.buy.sel{background:var(--grn-bg);border-color:var(--grn);}.dir-btn.sell.sel{background:var(--red-bg);border-color:var(--red);}

/* Live P&L */
.live-pnl{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:14px 16px;margin-bottom:16px;background:var(--s1);border:1px solid var(--brd);border-radius:var(--radius-sm);}
.live-pnl.cols4{grid-template-columns:repeat(4,1fr);}
.lp-item{text-align:center;}.lp-val{font-size:1.1rem;font-weight:700;font-family:'JetBrains Mono';}.lp-lbl{font-size:10px;color:var(--mut);margin-top:2px;}

/* Tags & Emotions */
.tags-row{display:flex;flex-wrap:wrap;gap:6px;}
.tag-btn{padding:6px 14px;border-radius:20px;border:1px solid var(--brd);background:transparent;color:var(--dim);font-size:12px;cursor:pointer;font-family:inherit;transition:all 0.2s;}
.tag-btn.sel{background:rgba(192,132,252,0.12);border-color:rgba(192,132,252,0.3);color:var(--pur);}
.emo-row{display:flex;gap:8px;}.emo-btn{font-size:24px;cursor:pointer;padding:6px;border:2px solid transparent;border-radius:12px;background:none;transition:all 0.2s;}.emo-btn.sel{border-color:var(--gld);background:rgba(251,191,36,0.08);}
.stars{display:flex;gap:4px;}.star{font-size:22px;cursor:pointer;color:var(--mut);transition:color 0.15s;background:none;border:none;}.star.lit{color:var(--gld);}

/* Save */
.save-btn{width:100%;padding:14px;background:var(--grn);color:#000;border:none;border-radius:var(--radius-sm);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;margin-top:8px;}
.save-btn:hover{opacity:0.9;transform:translateY(-1px);}

/* Portfolio */
.pos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;}
.pos-card{padding:16px;transition:all 0.25s;}.pos-card:hover{transform:translateY(-2px);border-color:var(--brd2);}
.pos-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.pos-inst{font-size:16px;font-weight:700;}.pos-dir{font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;text-transform:uppercase;}
.pos-dir.long,.pos-dir.buy{background:var(--grn-bg);color:var(--grn);}.pos-dir.short,.pos-dir.sell{background:var(--red-bg);color:var(--red);}
.pos-dir.hold{background:rgba(96,165,250,0.1);color:var(--blu);}
.pos-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;}
.pos-detail{display:flex;flex-direction:column;gap:2px;}.pos-detail .pd-lbl{color:var(--mut);font-size:10px;}.pos-detail .pd-val{font-family:'JetBrains Mono';font-weight:500;}
.pos-tags{margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;}
.status-open{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--gld);font-weight:600;}
.status-open::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--gld);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.status-closed{font-size:10px;color:var(--dim);}

/* Calendar */
.cal-nav{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:16px;}
.cal-nav button{background:var(--s1);border:1px solid var(--brd);color:var(--dim);padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;font-size:13px;transition:all 0.2s;}
.cal-nav button:hover{border-color:var(--cyn);color:var(--cyn);}.cal-nav .month{font-size:1.1rem;font-weight:700;min-width:180px;text-align:center;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.cal-hdr{text-align:center;font-size:11px;color:var(--mut);padding:8px;font-weight:600;}
.cal-day{min-height:72px;background:var(--s1);border:1px solid rgba(255,255,255,0.04);border-radius:var(--radius-sm);padding:8px;font-size:11px;transition:all 0.2s;}
.cal-day:hover{border-color:var(--brd2);}.cal-day .d-num{font-weight:600;color:var(--dim);margin-bottom:4px;}.cal-day .d-pnl{font-size:14px;font-weight:700;font-family:'JetBrains Mono';}.cal-day .d-cnt{font-size:9px;color:var(--mut);}
.cal-day.today{border-color:var(--cyn);}.cal-day.empty{background:transparent;border-color:transparent;}

/* Analytics */
.ana-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.streak-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px;}
.streak{text-align:center;padding:14px;}.streak .s-val{font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono';}.streak .s-lbl{font-size:10px;color:var(--mut);margin-top:4px;}

/* AC Section badges */
.ac-badge{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-weight:600;color:var(--txt);padding:8px 0;margin-bottom:8px;cursor:pointer;user-select:none;}
.ac-badge .ac-dot{width:8px;height:8px;border-radius:50%;}.ac-badge .ac-arrow{color:var(--mut);font-size:10px;transition:transform 0.2s;}.ac-badge .ac-arrow.collapsed{transform:rotate(-90deg);}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(30px);background:var(--grn);color:#000;padding:12px 24px;border-radius:30px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:all 0.35s cubic-bezier(0.16,1,0.3,1);box-shadow:0 4px 20px rgba(52,211,153,0.3);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

canvas{border-radius:var(--radius-sm);}
::-webkit-scrollbar{width:5px;height:5px;}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px;}

/* Responsive */
@media(max-width:768px){
    .app{padding:14px 14px 100px;}.header{flex-direction:column;gap:14px;align-items:flex-start;}
    .hdr-right{width:100%;flex-wrap:wrap;}.seg-ctrl{width:100%;flex:1;min-width:0;}
    .seg-btn{padding:7px 14px;font-size:12px;}.stats{grid-template-columns:repeat(2,1fr);gap:8px;}
    .stat .val{font-size:1.2rem;}.stat{padding:14px 8px;}.row2,.ana-grid{grid-template-columns:1fr;}
    .streak-row{grid-template-columns:repeat(2,1fr);}.pos-grid{grid-template-columns:1fr;}
    .filters{flex-direction:column;}.flt{width:100%;}.ac-sel{grid-template-columns:repeat(4,1fr);}
    .sheet{width:100%;max-width:100%;border-radius:20px 20px 0 0;position:fixed;bottom:0;left:0;right:0;max-height:85vh;animation:sheetUp 0.35s cubic-bezier(0.16,1,0.3,1);}
    @keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .fab{bottom:20px;right:20px;width:52px;height:52px;font-size:26px;}
    .fg-row3,.fg-row4{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){
    .app{padding:10px 10px 90px;}.seg-btn{padding:6px 10px;font-size:11px;}
    .stats{grid-template-columns:1fr 1fr;gap:6px;}.stat .val{font-size:1rem;}.stat .lbl{font-size:9px;}
    .card{padding:14px;border-radius:14px;}.fg-row,.fg-row3,.fg-row4{grid-template-columns:1fr;}
    .ac-sel{grid-template-columns:repeat(4,1fr);}.ac-opt{padding:8px 4px;font-size:10px;}
    .cal-day{min-height:50px;padding:5px;}.cal-day .d-pnl{font-size:12px;}
    table{font-size:11px;}th,td{padding:7px 8px;}
}
</style>
</head>
<body>
<div class="app">
<div class="header">
    <div class="logo">Tradyom<span>.</span>Journal</div>
    <div class="hdr-right">
        <button class="add-top-btn" onclick="openSheet()">+ New Trade</button>
        <div class="seg-ctrl" id="nav"></div>
        <div style="position:relative" id="user-wrap">
            <button id="user-btn" onclick="toggleUserMenu()" style="padding:6px 14px;background:var(--s1);border:1px solid var(--brd);border-radius:20px;color:var(--dim);font-size:11px;font-family:inherit;cursor:pointer;transition:all 0.2s;white-space:nowrap"></button>
            <div id="user-menu" style="display:none;position:absolute;right:0;top:calc(100% + 6px);background:#1a1a1a;border:1px solid var(--brd2);border-radius:12px;min-width:160px;z-index:100;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
                <button onclick="openSheet();toggleUserMenu()" style="display:block;width:100%;padding:12px 16px;background:none;border:none;color:var(--txt);font-size:13px;font-family:inherit;cursor:pointer;text-align:left;transition:background 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)'" onmouseleave="this.style.background=''">+ Add a Trade</button>
                <div style="height:1px;background:var(--brd)"></div>
                <button onclick="handleSignOut()" style="display:block;width:100%;padding:12px 16px;background:none;border:none;color:var(--red);font-size:13px;font-family:inherit;cursor:pointer;text-align:left;transition:background 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)'" onmouseleave="this.style.background=''">Logout</button>
            </div>
        </div>
    </div>
</div>
<div id="panels"></div>
</div>
<button class="fab" onclick="openSheet()" title="Add Trade">+</button>
<div class="toast" id="toast"></div>
<div class="sheet-bg" id="sheetBg" onclick="closeSheet()">
<div class="sheet" onclick="event.stopPropagation()" id="sheetInner">
    <button class="sheet-close" onclick="closeSheet()">√ó</button>
    <h2>New Trade</h2>
    <div class="sub">Select asset class to begin</div>
    <div id="sheetForm"></div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê SUPABASE ‚ïê‚ïê‚ïê
const SUPABASE_URL='https://iyvuejfsageohhguenjm.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5dnVlamZzYWdlb2hoZ3VlbmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTQwNDgsImV4cCI6MjA4Nzc3MDA0OH0.iipRqsyYiNR4pX4YVOEzbgA4ZDR1tf6lxeA6mEv9ALA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
let currentUser=null;

// Auth guard ‚Äî redirect to auth if not logged in
async function checkAuth(){
    const{data:{session}}=await sb.auth.getSession();
    if(!session){window.location.href='auth.html';return false;}
    currentUser=session.user;
    // Show username in header
    const prof=await sb.from('profiles').select('username').eq('id',currentUser.id).single();
    if(prof.data)currentUser.username=prof.data.username;
    return true;
}

// ‚ïê‚ïê‚ïê ASSET CLASS CONFIG ‚ïê‚ïê‚ïê
const AC = {
    stocks:   {label:'Stocks',icon:'üìà',color:'#60a5fa',fields:'stock'},
    options:  {label:'Options',icon:'üìã',color:'#c084fc',fields:'option'},
    forex:    {label:'Forex',icon:'üí±',color:'#67e8f9',fields:'forex'},
    indices:  {label:'Indices',icon:'üìä',color:'#a78bfa',fields:'index'},
    commodities:{label:'Commodities',icon:'ü•á',color:'#fb923c',fields:'commodity'},
    futures:  {label:'Futures',icon:'üìú',color:'#fbbf24',fields:'future'},
    angel:    {label:'Angel / VC',icon:'üëº',color:'#f472b6',fields:'angel'},
    realestate:{label:'Real Estate',icon:'üè†',color:'#4ade80',fields:'realestate'}
};
const AC_COLORS = {};Object.entries(AC).forEach(([k,v])=>AC_COLORS[v.label]=v.color);

// ‚ïê‚ïê‚ïê INSTRUMENTS BY CLASS ‚ïê‚ïê‚ïê
const INST = {
    stocks:["AAPL","ABBV","ABNB","ABT","ACN","ADBE","ADI","ADP","AMAT","AMD","AMGN","AMT","AMZN","ANSS","AON","AVGO","AXP","BA","BAC","BIIB","BKNG","BKR","BLK","BMY","BRK.B","CAT","CB","CCEP","CDNS","CDW","CEG","CI","CL","CMCSA","CME","COST","CPRT","CRM","CRWD","CSCO","CSX","CTAS","CTSH","CVX","DASH","DDOG","DE","DHR","DIS","DLTR","DOW","DUK","DXCM","EA","EMR","EXC","F","FANG","FAST","FDX","FTNT","GE","GEHC","GFS","GILD","GM","GOOG","GOOGL","GS","HD","HON","IBM","ICE","IDXX","ILMN","INTC","INTU","ISRG","ITW","JNJ","JPM","KDP","KHC","KLAC","KO","LCID","LIN","LLY","LOW","LRCX","LULU","MA","MAR","MCD","MCHP","MCO","MDB","MDLZ","MELI","META","MMC","MMM","MNST","MRK","MRNA","MRVL","MS","MSFT","MU","NEE","NFLX","NKE","NSC","NVDA","NXPI","ODFL","ON","ORLY","PANW","PAYX","PCAR","PEP","PFE","PG","PLD","PM","PNC","PYPL","QCOM","REGN","RIVN","ROP","ROST","RTX","SBUX","SCHW","SHW","SIRI","SNPS","SO","SPGI","SPLK","SYK","T","TEAM","TGT","TJX","TMO","TMUS","TRV","TSLA","TTD","TXN","UNH","UNP","UPS","USB","V","VRSK","VRTX","VZ","WBA","WBD","WDAY","WELL","WM","WMT","XEL","XOM","ZS"],
    options:["AAPL","AMZN","AMD","GOOGL","META","MSFT","NVDA","TSLA","SPY","QQQ","IWM","XSP","NFLX","BA","DIS","PYPL","COIN","BABA","NIO","PLTR","SOFI","RIVN","LCID"],
    forex:["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY","AUDJPY","EURCHF","EURAUD","GBPAUD","GBPCAD","USDSGD","USDHKD","USDTRY","USDMXN","USDZAR"],
    indices:["SPX500","NAS100","US30","UK100","GER40","JPN225","AUS200","FRA40","HK50","VIX"],
    commodities:["XAUUSD","XAGUSD","XPTUSD","XPDUSD","WTIUSD","BRENTUSD","NATGASUSD","COPPERUSD","WHEATUSD","CORNUSD","SOYBEANUSD","COFFEEUSD","SUGARUSD","COTTONUSD"],
    futures:["ES","NQ","YM","RTY","GC","SI","CL","NG","ZB","ZN","6E","6B","6J","6A","ZC","ZW","ZS"],
    angel:[],realestate:[]
};

const TAGS=['breakout','trend','scalp','swing','news','reversal','support','resistance','earnings','macro','technical','fundamental'];
const EMOTIONS=['üòé','üò∞','üòê','üî•','üßä'];
const RE_TYPES=['Residential','Commercial','Industrial','Land','Mixed-Use','Office','Retail'];

function getAC(t){return t.assetClass||'stocks';}
function getACLabel(t){return AC[getAC(t)]?.label||'Stocks';}

// ‚ïê‚ïê‚ïê P&L CALCULATIONS PER ASSET CLASS ‚ïê‚ïê‚ïê
function calcPnL(t){
    const ac=getAC(t);
    switch(ac){
        case 'stocks': return (t.direction==='LONG'?(t.exit-t.entry):(t.entry-t.exit))*(t.shares||0);
        case 'options': return ((t.exitPremium||0)-(t.premium||0))*(t.contracts||1)*100*(t.direction==='LONG'?1:-1);
        case 'forex': {
            const pips=t.direction==='LONG'?(t.exit-t.entry):(t.entry-t.exit);
            const pipDec=t.instrument?.includes('JPY')?0.01:0.0001;
            const pipCount=pips/pipDec;
            const pipVal=t.pipValue||10;
            return pipCount*(t.lots||0)*pipVal;
        }
        case 'indices': return (t.direction==='LONG'?(t.exit-t.entry):(t.entry-t.exit))*(t.contracts||1)*(t.pointValue||1);
        case 'commodities': return (t.direction==='LONG'?(t.exit-t.entry):(t.entry-t.exit))*(t.lots||0)*(t.contractSize||100);
        case 'futures': return (t.direction==='LONG'?(t.exit-t.entry):(t.entry-t.exit))*(t.contracts||1)*(t.tickValue||12.5)/(t.tickSize||0.25);
        case 'angel': return t.exitValuation&&t.investmentAmount?((t.exitValuation*(t.equityPct||0)/100)-t.investmentAmount):0;
        case 'realestate': return (t.currentValue||0)-(t.purchasePrice||0);
        default: return 0;
    }
}

// ‚ïê‚ïê‚ïê DATA LAYER (Supabase + localStorage fallback) ‚ïê‚ïê‚ïê
function getTrades(){let t=localStorage.getItem('tj-trades-v2');if(!t)return[];return JSON.parse(t);}
function saveTradesLocal(t){localStorage.setItem('tj-trades-v2',JSON.stringify(t));}
function saveTrades(t){saveTradesLocal(t);}

let trades=getTrades();

// Load trades from Supabase (called after auth check)
async function loadTradesFromDB(){
    if(!currentUser)return;
    const{data,error}=await sb.from('trades').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
    if(error){console.warn('DB load failed, using localStorage:',error.message);return;}
    if(data&&data.length>0){
        trades=data.map(dbToTrade);saveTradesLocal(trades);render();
    }
}

// Save a single trade to Supabase
async function saveTradeDB(t){
    if(!currentUser)return;
    const row=tradeToDb(t);
    const{error}=await sb.from('trades').upsert(row);
    if(error)console.warn('DB save failed:',error.message);
}

// Map DB row ‚Üí local trade object
function dbToTrade(r){
    return{id:r.id,date:r.date_opened,assetClass:r.asset_class,instrument:r.instrument,direction:r.direction,
        entry:r.entry_price?+r.entry_price:null,exit:r.exit_price?+r.exit_price:null,
        shares:r.shares?+r.shares:null,lots:r.lots?+r.lots:null,contracts:r.contracts?+r.contracts:null,
        pipValue:r.pip_value?+r.pip_value:null,contractSize:r.contract_size?+r.contract_size:null,
        pointValue:r.point_value?+r.point_value:null,tickSize:r.tick_size?+r.tick_size:null,tickValue:r.tick_value?+r.tick_value:null,
        optionType:r.option_type,strike:r.strike?+r.strike:null,expiry:r.expiry,premium:r.premium?+r.premium:null,exitPremium:r.exit_premium?+r.exit_premium:null,
        investmentAmount:r.investment_amount?+r.investment_amount:null,equityPct:r.equity_pct?+r.equity_pct:null,valuation:r.valuation?+r.valuation:null,exitValuation:r.exit_valuation?+r.exit_valuation:null,status:r.deal_status,
        propertyType:r.property_type,purchasePrice:r.purchase_price?+r.purchase_price:null,currentValue:r.current_value?+r.current_value:null,generatesRent:r.generates_rent,monthlyRent:r.monthly_rent?+r.monthly_rent:null,monthlyExpenses:r.monthly_expenses?+r.monthly_expenses:null,
        pnl:r.pnl?+r.pnl:0,tags:r.tags||[],notes:r.notes||'',emotion:r.emotion||'',rating:r.rating||0,duration:null};
}

// Map local trade ‚Üí DB row
function tradeToDb(t){
    return{user_id:currentUser?.id,asset_class:t.assetClass||'stocks',instrument:t.instrument,direction:t.direction||null,
        entry_price:t.entry||null,exit_price:t.exit||null,date_opened:t.date||new Date().toISOString(),
        pnl:t.pnl||0,notes:t.notes||'',tags:t.tags||[],emotion:t.emotion||'',rating:t.rating||0,
        shares:t.shares||null,lots:t.lots||null,contracts:t.contracts||null,
        pip_value:t.pipValue||null,contract_size:t.contractSize||null,point_value:t.pointValue||null,
        tick_size:t.tickSize||null,tick_value:t.tickValue||null,
        option_type:t.optionType||null,strike:t.strike||null,expiry:t.expiry||null,premium:t.premium||null,exit_premium:t.exitPremium||null,
        investment_amount:t.investmentAmount||null,equity_pct:t.equityPct||null,valuation:t.valuation||null,exit_valuation:t.exitValuation||null,deal_status:t.status||null,
        property_type:t.propertyType||null,purchase_price:t.purchasePrice||null,current_value:t.currentValue||null,
        generates_rent:t.generatesRent||false,monthly_rent:t.monthlyRent||null,monthly_expenses:t.monthlyExpenses||null};
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function pnlColor(v){return v>=0?'var(--grn)':'var(--red)';}
function fmt$(v){if(v===null||v===undefined||isNaN(v))return'‚Äî';return(v>=0?'+':'')+v.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0});}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function isOpen(t){return t.exit===null||t.exit===undefined||t.exit===''||t.exit===0;}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
const TABS=['Dashboard','Trade Log','Portfolio','Calendar','Analytics'];
let curTab=0;
function initNav(){document.getElementById('nav').innerHTML=TABS.map((t,i)=>`<button class="seg-btn${i===0?' on':''}" onclick="switchTab(${i})">${t}</button>`).join('');}
function switchTab(i){curTab=i;document.querySelectorAll('.seg-btn').forEach((b,j)=>b.classList.toggle('on',j===i));render();}
function render(){const p=document.getElementById('panels');p.innerHTML='<div class="pnl on" id="pnl"></div>';[renderDashboard,renderTradeLog,renderPortfolio,renderCalendar,renderAnalytics][curTab]();}

// ‚ïê‚ïê‚ïê ADD TRADE SHEET ‚ïê‚ïê‚ïê
let addAC='stocks',addDir='LONG',addTags=new Set(),addEmo='',addRating=0,addInst='',addOptType='CALL';
function openSheet(){addAC='stocks';addDir='LONG';addTags.clear();addEmo='';addRating=0;addInst='';addOptType='CALL';document.getElementById('sheetBg').classList.add('show');renderForm();}
function closeSheet(){document.getElementById('sheetBg').classList.remove('show');}

function renderForm(){
    const f=document.getElementById('sheetForm');
    const acConf=AC[addAC];
    // Asset class selector
    let h=`<div class="ac-sel">${Object.entries(AC).map(([k,v])=>`<button class="ac-opt ${addAC===k?'sel':''}" onclick="addAC='${k}';addInst='';renderForm()"><span class="ac-icon">${v.icon}</span>${v.label}</button>`).join('')}</div>`;

    // Instrument
    if(addAC==='angel'){
        h+=`<div class="fg"><label>Company / Project Name</label><input type="text" id="f-inst" placeholder="e.g. TechStartup Inc." value="${addInst}" oninput="addInst=this.value"/></div>`;
    } else if(addAC==='realestate'){
        h+=`<div class="fg"><label>Property Name / Address</label><input type="text" id="f-inst" placeholder="e.g. Dubai Marina Apt" value="${addInst}" oninput="addInst=this.value"/></div>`;
        h+=`<div class="fg"><label>Property Type</label><select id="f-retype" onchange="this.dataset.val=this.value">${RE_TYPES.map(t=>`<option>${t}</option>`).join('')}</select></div>`;
    } else {
        const instList=INST[addAC]||[];
        h+=`<div class="fg" style="position:relative"><label>Instrument</label>
            <input type="text" id="f-inst" placeholder="Search ticker..." value="${addInst}" oninput="addInst=this.value;filterInst(this.value)" onfocus="document.getElementById('inst-dd').style.display='block'" autocomplete="off"/>
            <div id="inst-dd" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:180px;overflow-y:auto;background:#1a1a1a;border:1px solid var(--brd2);border-radius:12px;z-index:50;margin-top:4px"></div></div>`;
    }

    // Direction (not for angel/realestate)
    if(!['angel','realestate'].includes(addAC)){
        h+=`<div class="dir-btns">
            <button class="dir-btn long ${addDir==='LONG'?'sel':''}" onclick="addDir='LONG';renderForm()">‚ñ≤ LONG</button>
            <button class="dir-btn short ${addDir==='SHORT'?'sel':''}" onclick="addDir='SHORT';renderForm()">‚ñº SHORT</button></div>`;
    }

    // ‚îÄ‚îÄ‚îÄ ASSET-CLASS SPECIFIC FIELDS ‚îÄ‚îÄ‚îÄ
    if(addAC==='stocks'){
        h+=`<div class="live-pnl"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-pct" style="color:var(--dim)">0%</div><div class="lp-lbl">Return</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row3"><div class="fg"><label>Entry Price</label><input type="number" step="any" id="f-ep" placeholder="0.00" oninput="calcLive()"/></div><div class="fg"><label>Exit Price</label><input type="number" step="any" id="f-xp" placeholder="Leave empty if open" oninput="calcLive()"/></div><div class="fg"><label>Shares</label><input type="number" step="1" id="f-shares" placeholder="100" value="" oninput="calcLive()"/></div></div>`;
    } else if(addAC==='options'){
        h+=`<div class="fg-row"><div class="fg"><label>Option Type</label><div class="dir-btns" style="margin:0"><button class="dir-btn buy ${addOptType==='CALL'?'sel':''}" onclick="addOptType='CALL';renderForm()" style="color:var(--grn)">üìû CALL</button><button class="dir-btn sell ${addOptType==='PUT'?'sel':''}" onclick="addOptType='PUT';renderForm()" style="color:var(--red)">üìâ PUT</button></div></div></div>`;
        h+=`<div class="live-pnl cols4"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-pct" style="color:var(--dim)">0%</div><div class="lp-lbl">Return</div></div><div class="lp-item"><div class="lp-val" id="lp-cont" style="color:var(--dim)">0</div><div class="lp-lbl">Contracts</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row"><div class="fg"><label>Strike Price</label><input type="number" step="any" id="f-strike"/></div><div class="fg"><label>Expiry Date</label><input type="date" id="f-expiry"/></div></div>`;
        h+=`<div class="fg-row3"><div class="fg"><label>Entry Premium</label><input type="number" step="any" id="f-premium" oninput="calcLive()"/></div><div class="fg"><label>Exit Premium</label><input type="number" step="any" id="f-xpremium" placeholder="Leave empty if open" oninput="calcLive()"/></div><div class="fg"><label>Contracts</label><input type="number" step="1" id="f-contracts" value="1" oninput="calcLive()"/></div></div>`;
    } else if(addAC==='forex'){
        h+=`<div class="live-pnl cols4"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-pips" style="color:var(--dim)">0</div><div class="lp-lbl">Pips</div></div><div class="lp-item"><div class="lp-val" id="lp-lots" style="color:var(--dim)">0</div><div class="lp-lbl">Lots</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row4"><div class="fg"><label>Entry</label><input type="number" step="any" id="f-ep" oninput="calcLive()"/></div><div class="fg"><label>Exit</label><input type="number" step="any" id="f-xp" placeholder="Open if empty" oninput="calcLive()"/></div><div class="fg"><label>Lots</label><input type="number" step="0.01" id="f-lots" value="0.10" oninput="calcLive()"/></div><div class="fg"><label>Pip Value ($)</label><input type="number" step="any" id="f-pipval" value="10" oninput="calcLive()"/></div></div>`;
    } else if(addAC==='commodities'){
        h+=`<div class="live-pnl"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-lots" style="color:var(--dim)">0</div><div class="lp-lbl">Lots</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row4"><div class="fg"><label>Entry</label><input type="number" step="any" id="f-ep" oninput="calcLive()"/></div><div class="fg"><label>Exit</label><input type="number" step="any" id="f-xp" placeholder="Open if empty" oninput="calcLive()"/></div><div class="fg"><label>Lots</label><input type="number" step="0.01" id="f-lots" value="1" oninput="calcLive()"/></div><div class="fg"><label>Contract Size</label><input type="number" step="1" id="f-csize" value="100" oninput="calcLive()"/><div class="hint">Gold=100, Silver=5000, Oil=1000</div></div></div>`;
    } else if(addAC==='indices'){
        h+=`<div class="live-pnl"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-pts" style="color:var(--dim)">0</div><div class="lp-lbl">Points</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row4"><div class="fg"><label>Entry</label><input type="number" step="any" id="f-ep" oninput="calcLive()"/></div><div class="fg"><label>Exit</label><input type="number" step="any" id="f-xp" placeholder="Open if empty" oninput="calcLive()"/></div><div class="fg"><label>Contracts</label><input type="number" step="1" id="f-contracts" value="1" oninput="calcLive()"/></div><div class="fg"><label>$/Point</label><input type="number" step="any" id="f-ptval" value="1" oninput="calcLive()"/></div></div>`;
    } else if(addAC==='futures'){
        h+=`<div class="live-pnl"><div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div><div class="lp-item"><div class="lp-val" id="lp-ticks" style="color:var(--dim)">0</div><div class="lp-lbl">Ticks</div></div><div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div></div>`;
        h+=`<div class="fg-row4"><div class="fg"><label>Entry</label><input type="number" step="any" id="f-ep" oninput="calcLive()"/></div><div class="fg"><label>Exit</label><input type="number" step="any" id="f-xp" placeholder="Open if empty" oninput="calcLive()"/></div><div class="fg"><label>Contracts</label><input type="number" step="1" id="f-contracts" value="1" oninput="calcLive()"/></div><div class="fg"><label>Tick Size / Value</label><div class="fg-row" style="gap:6px"><input type="number" step="any" id="f-ticksz" value="0.25" placeholder="Tick Size" oninput="calcLive()" style="padding:10px 12px;font-size:13px"/><input type="number" step="any" id="f-tickval" value="12.50" placeholder="Tick $" oninput="calcLive()" style="padding:10px 12px;font-size:13px"/></div></div></div>`;
    } else if(addAC==='angel'){
        h+=`<div class="fg-row"><div class="fg"><label>Investment Amount ($)</label><input type="number" step="any" id="f-invest"/></div><div class="fg"><label>Equity %</label><input type="number" step="0.01" id="f-equity" placeholder="2.5"/></div></div>`;
        h+=`<div class="fg-row"><div class="fg"><label>Valuation at Entry ($)</label><input type="number" step="any" id="f-valuation"/></div><div class="fg"><label>Current / Exit Valuation ($)</label><input type="number" step="any" id="f-exitval" placeholder="Leave empty if active"/></div></div>`;
        h+=`<div class="fg"><label>Status</label><select id="f-status"><option>active</option><option>exited</option><option>written-off</option></select></div>`;
    } else if(addAC==='realestate'){
        h+=`<div class="fg-row"><div class="fg"><label>Purchase Price ($)</label><input type="number" step="any" id="f-purchase"/></div><div class="fg"><label>Current Value ($)</label><input type="number" step="any" id="f-curval"/></div></div>`;
        h+=`<div class="fg"><label>Generates Rent / Revenue?</label><div class="dir-btns" style="margin:0"><button class="dir-btn buy" id="rent-y" onclick="document.getElementById('rent-fields').style.display='grid';this.classList.add('sel');document.getElementById('rent-n').classList.remove('sel')" style="color:var(--grn)">Yes</button><button class="dir-btn sell" id="rent-n" onclick="document.getElementById('rent-fields').style.display='none';this.classList.add('sel');document.getElementById('rent-y').classList.remove('sel')" style="color:var(--red)">No</button></div></div>`;
        h+=`<div class="fg-row" id="rent-fields" style="display:none"><div class="fg"><label>Monthly Rent ($)</label><input type="number" step="any" id="f-rent"/></div><div class="fg"><label>Monthly Expenses ($)</label><input type="number" step="any" id="f-expenses"/></div></div>`;
    }

    // Dates (not for angel/realestate which have their own)
    if(!['angel','realestate'].includes(addAC)){
        h+=`<div class="fg-row" style="margin-top:4px"><div class="fg"><label>Entry Date</label><input type="datetime-local" id="f-ed" value="${new Date().toISOString().slice(0,16)}" oninput="calcLive()"/></div><div class="fg"><label>Exit Date</label><input type="datetime-local" id="f-xd" value="${new Date().toISOString().slice(0,16)}" oninput="calcLive()"/></div></div>`;
    } else {
        h+=`<div class="fg"><label>Date</label><input type="date" id="f-ed" value="${new Date().toISOString().slice(0,10)}"/></div>`;
    }

    // Tags
    h+=`<div class="fg"><label>Tags</label><div class="tags-row">${TAGS.map(t=>`<button class="tag-btn ${addTags.has(t)?'sel':''}" onclick="toggleTag(this,'${t}')">${t}</button>`).join('')}</div></div>`;

    // Emotion & Rating
    h+=`<div style="display:flex;gap:24px;margin-bottom:16px"><div class="fg" style="margin:0"><label>Emotion</label><div class="emo-row">${EMOTIONS.map(e=>`<button class="emo-btn ${addEmo===e?'sel':''}" onclick="pickEmo(this,'${e}')">${e}</button>`).join('')}</div></div><div class="fg" style="margin:0"><label>Rating</label><div class="stars">${[1,2,3,4,5].map(i=>`<button class="star ${i<=addRating?'lit':''}" onclick="pickRating(${i})">‚òÖ</button>`).join('')}</div></div></div>`;

    // Notes
    h+=`<div class="fg"><label>Notes</label><textarea id="f-notes" placeholder="What was your thesis?"></textarea></div>`;
    h+=`<button class="save-btn" onclick="saveTrade()">Save Trade</button>`;

    f.innerHTML=h;
    // Update sheet subtitle
    document.querySelector('.sheet .sub').textContent=acConf.icon+' '+acConf.label+' Trade';
    // Close dropdown
    document.addEventListener('click',e=>{if(!e.target.closest('#f-inst')&&!e.target.closest('#inst-dd')){const d=document.getElementById('inst-dd');if(d)d.style.display='none';}},{once:true});
}

function filterInst(q){
    const dd=document.getElementById('inst-dd');if(!dd)return;
    const list=(INST[addAC]||[]).filter(i=>i.toLowerCase().includes(q.toLowerCase())).slice(0,12);
    dd.innerHTML=list.map(i=>`<div style="padding:10px 16px;cursor:pointer;font-size:14px;font-weight:500;border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)'" onmouseleave="this.style.background=''" onclick="addInst='${i}';document.getElementById('f-inst').value='${i}';document.getElementById('inst-dd').style.display='none'">${i}</div>`).join('');
    dd.style.display=list.length?'block':'none';
}

function calcLive(){
    const el=id=>{const e=document.getElementById(id);return e?+e.value:0;};
    const elS=id=>document.getElementById(id);
    const ep=el('f-ep'),xp=el('f-xp'),ed=elS('f-ed')?.value,xd=elS('f-xd')?.value;
    let pnl=0,extra={};

    if(addAC==='stocks'){
        const sh=el('f-shares');if(!ep)return;
        pnl=(addDir==='LONG'?(xp-ep):(ep-xp))*sh;
        const pct=ep?(((xp||ep)-ep)/ep*100).toFixed(2):0;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-pct')){elS('lp-pct').textContent=(pct>=0?'+':'')+pct+'%';elS('lp-pct').style.color=pnlColor(pnl);}
    } else if(addAC==='options'){
        const prem=el('f-premium'),xprem=el('f-xpremium'),cont=el('f-contracts')||1;
        pnl=((xprem||0)-prem)*(addDir==='LONG'?1:-1)*cont*100;
        const pct=prem?((xprem-prem)/prem*100).toFixed(2):0;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-pct')){elS('lp-pct').textContent=(pct>=0?'+':'')+pct+'%';elS('lp-pct').style.color=pnlColor(pnl);}
        if(elS('lp-cont'))elS('lp-cont').textContent=cont;
    } else if(addAC==='forex'){
        const lots=el('f-lots'),pipVal=el('f-pipval')||10;
        const isJpy=addInst.includes('JPY');const pipDec=isJpy?0.01:0.0001;
        const rawPips=(addDir==='LONG'?(xp-ep):(ep-xp));
        const pips=ep?Math.round(rawPips/pipDec):0;
        pnl=pips*lots*pipVal;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-pips')){elS('lp-pips').textContent=pips;elS('lp-pips').style.color=pnlColor(pips);}
        if(elS('lp-lots'))elS('lp-lots').textContent=lots;
    } else if(addAC==='commodities'){
        const lots=el('f-lots'),csize=el('f-csize')||100;
        pnl=(addDir==='LONG'?(xp-ep):(ep-xp))*lots*csize;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-lots'))elS('lp-lots').textContent=lots;
    } else if(addAC==='indices'){
        const cont=el('f-contracts')||1,ptval=el('f-ptval')||1;
        const pts=xp-ep;pnl=(addDir==='LONG'?pts:-pts)*cont*ptval;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-pts')){elS('lp-pts').textContent=Math.round(addDir==='LONG'?pts:-pts);elS('lp-pts').style.color=pnlColor(pnl);}
    } else if(addAC==='futures'){
        const cont=el('f-contracts')||1,tsz=el('f-ticksz')||0.25,tval=el('f-tickval')||12.5;
        const rawDiff=addDir==='LONG'?(xp-ep):(ep-xp);
        const ticks=tsz?rawDiff/tsz:0;pnl=ticks*tval*cont;
        if(elS('lp-pnl')){elS('lp-pnl').textContent=fmt$(Math.round(pnl));elS('lp-pnl').style.color=pnlColor(pnl);}
        if(elS('lp-ticks')){elS('lp-ticks').textContent=Math.round(ticks);elS('lp-ticks').style.color=pnlColor(pnl);}
    }
    // Duration
    if(ed&&xd&&elS('lp-dur')){const h=Math.round((new Date(xd)-new Date(ed))/3600000);elS('lp-dur').textContent=h>0?h+'h':'‚Äî';}
}

function saveTrade(){
    const inst=addInst||document.getElementById('f-inst')?.value||'';
    if(!inst){toast('‚ö†Ô∏è Enter instrument/name');return;}
    const el=id=>{const e=document.getElementById(id);return e?e.value:null;};
    const elN=id=>{const v=el(id);return v?+v:null;};
    let t={id:Date.now(),date:el('f-ed')||new Date().toISOString().slice(0,16),assetClass:addAC,instrument:inst,
        tags:[...addTags],notes:el('f-notes')||'',emotion:addEmo,rating:addRating};

    if(addAC==='stocks'){
        Object.assign(t,{direction:addDir,entry:elN('f-ep'),exit:elN('f-xp')||null,shares:elN('f-shares')||0});
        if(!t.entry){toast('‚ö†Ô∏è Enter entry price');return;}
    } else if(addAC==='options'){
        Object.assign(t,{direction:addDir,optionType:addOptType,strike:elN('f-strike'),expiry:el('f-expiry'),
            premium:elN('f-premium'),exitPremium:elN('f-xpremium')||null,contracts:elN('f-contracts')||1});
        if(!t.premium){toast('‚ö†Ô∏è Enter premium');return;}
    } else if(addAC==='forex'){
        Object.assign(t,{direction:addDir,entry:elN('f-ep'),exit:elN('f-xp')||null,lots:elN('f-lots')||0.1,pipValue:elN('f-pipval')||10});
        if(!t.entry){toast('‚ö†Ô∏è Enter entry price');return;}
    } else if(addAC==='commodities'){
        Object.assign(t,{direction:addDir,entry:elN('f-ep'),exit:elN('f-xp')||null,lots:elN('f-lots')||1,contractSize:elN('f-csize')||100});
        if(!t.entry){toast('‚ö†Ô∏è Enter entry price');return;}
    } else if(addAC==='indices'){
        Object.assign(t,{direction:addDir,entry:elN('f-ep'),exit:elN('f-xp')||null,contracts:elN('f-contracts')||1,pointValue:elN('f-ptval')||1});
        if(!t.entry){toast('‚ö†Ô∏è Enter entry price');return;}
    } else if(addAC==='futures'){
        Object.assign(t,{direction:addDir,entry:elN('f-ep'),exit:elN('f-xp')||null,contracts:elN('f-contracts')||1,tickSize:elN('f-ticksz')||0.25,tickValue:elN('f-tickval')||12.5});
        if(!t.entry){toast('‚ö†Ô∏è Enter entry price');return;}
    } else if(addAC==='angel'){
        Object.assign(t,{investmentAmount:elN('f-invest'),equityPct:elN('f-equity'),valuation:elN('f-valuation'),
            exitValuation:elN('f-exitval')||null,status:el('f-status')||'active'});
    } else if(addAC==='realestate'){
        const rentY=document.getElementById('rent-y')?.classList.contains('sel');
        Object.assign(t,{propertyType:el('f-retype')||'Residential',purchasePrice:elN('f-purchase'),currentValue:elN('f-curval'),
            generatesRent:rentY,monthlyRent:elN('f-rent')||0,monthlyExpenses:elN('f-expenses')||0});
    }
    t.pnl=Math.round(calcPnL(t));
    t.duration=null;
    const ed=el('f-ed'),xd=el('f-xd');
    if(ed&&xd){const h=Math.round((new Date(xd)-new Date(ed))/3600000);if(h>0)t.duration=h+'h';}

    trades.unshift(t);saveTrades(trades);
    saveTradeDB(t); // async save to Supabase
    closeSheet();toast('‚úÖ Trade saved');switchTab(2);
}

// ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê
function renderDashboard(){
    const t=trades;const closed=t.filter(x=>!isOpen(x));
    const totalPnl=closed.reduce((s,x)=>s+(x.pnl||0),0);
    const wins=closed.filter(x=>(x.pnl||0)>0).length;
    const losses=closed.filter(x=>(x.pnl||0)<=0).length;
    const winRate=closed.length?(wins/closed.length*100).toFixed(1):0;
    const avgWin=wins?closed.filter(x=>x.pnl>0).reduce((s,x)=>s+x.pnl,0)/wins:0;
    const avgLoss=losses?Math.abs(closed.filter(x=>x.pnl<=0).reduce((s,x)=>s+x.pnl,0)/losses):1;
    const pf=(avgWin/avgLoss).toFixed(2);
    const best=closed.length?Math.max(...closed.map(x=>x.pnl)):0;
    const openCount=t.filter(x=>isOpen(x)).length;

    // Welcome message
    let h=`<div class="card" style="margin-bottom:16px;border-color:rgba(52,211,153,0.15);background:linear-gradient(135deg,rgba(52,211,153,0.04),rgba(103,232,249,0.03))">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
            <span style="font-size:24px">üìä</span>
            <div><div style="font-size:16px;font-weight:700">Welcome to Tradyom Journal</div>
            <div style="font-size:12px;color:var(--dim);margin-top:2px">by the Tradyom Team</div></div>
        </div>
        <div style="font-size:13px;color:var(--dim);line-height:1.6">
            Track every trade across stocks, options, forex, commodities, futures, angel investments, and real estate ‚Äî all in one place.
            Log your entries, exits, emotions, and lessons. Build discipline. Grow your edge. Your journal is your most powerful trading tool.
            <span style="color:var(--grn);font-weight:600">Start by adding your first trade ‚Üó</span>
        </div>
    </div>`;

    h+=`<div class="stats">
        <div class="card stat"><div class="lbl">Realized P&L</div><div class="val" style="color:${pnlColor(totalPnl)}">${fmt$(totalPnl)}</div><div class="lbl">${closed.length} closed</div></div>
        <div class="card stat"><div class="lbl">Win Rate</div><div class="val" style="color:var(--cyn)">${winRate}%</div><div class="lbl">${wins}W / ${losses}L</div></div>
        <div class="card stat"><div class="lbl">Open Positions</div><div class="val" style="color:var(--gld)">${openCount}</div><div class="lbl">active</div></div>
        <div class="card stat"><div class="lbl">Profit Factor</div><div class="val" style="color:var(--gld)">${pf}</div><div class="lbl">avg win / loss</div></div>
        <div class="card stat"><div class="lbl">Best Trade</div><div class="val" style="color:var(--grn)">${fmt$(best)}</div><div class="lbl">single trade</div></div>
    </div>`;
    h+=`<div class="row2"><div class="card"><div class="card-title">Equity Curve</div><canvas id="eqCanvas" height="260"></canvas></div><div class="card"><div class="card-title">Recent Trades</div><div id="recentList"></div></div></div>`;

    // Earnings Calendar
    const today=new Date().toISOString().slice(0,10);
    const upcoming=EARNINGS_CAL.filter(e=>e.date>=today).slice(0,10);
    h+=`<div class="row2"><div class="card"><div class="card-title">Portfolio Treemap</div><canvas id="tmCanvas" height="280"></canvas></div>
    <div class="card"><div class="card-title">üìÖ US Earnings Calendar</div>
    <div style="max-height:280px;overflow-y:auto">
    ${upcoming.length?upcoming.map(e=>{
        const d=new Date(e.date+'T12:00:00');const ds=d.toLocaleDateString('en-US',{month:'short',day:'numeric',weekday:'short'});
        return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px">
            <div><span style="font-weight:700;color:var(--cyn)">${e.ticker}</span> <span style="color:var(--dim)">${e.name}</span></div>
            <div style="display:flex;gap:8px;align-items:center"><span style="font-size:11px;color:var(--mut)">${ds}</span><span style="font-size:10px;padding:2px 6px;border-radius:6px;background:${e.time==='BMO'?'rgba(251,191,36,0.1)':'rgba(103,232,249,0.1)'};color:${e.time==='BMO'?'var(--gld)':'var(--cyn)'}">${e.time}</span></div>
        </div>`;}).join(''):'<div style="color:var(--mut);font-size:13px;padding:20px 0;text-align:center">No upcoming earnings</div>'}
    </div></div></div>`;
    document.getElementById('pnl').innerHTML=h;
    drawEquity();drawTreemap();
    document.getElementById('recentList').innerHTML=t.slice(0,10).map(r=>{
        const acl=AC[getAC(r)]||{};
        return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px">
            <div><span style="font-weight:600">${r.instrument}</span> <span style="font-size:10px;color:${acl.color||'#888'}">${acl.label||''}</span>
            ${isOpen(r)?'<span class="status-open">OPEN</span>':r.direction?`<span class="${r.direction==='LONG'?'dir-long':'dir-short'}" style="font-size:11px">${r.direction}</span>`:''}</div>
            <div style="color:${pnlColor(r.pnl||0)};font-weight:600;font-family:'JetBrains Mono'">${isOpen(r)?'‚Äî':fmt$(r.pnl||0)}</div></div>`;
    }).join('');
}

function drawEquity(){
    const c=document.getElementById('eqCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const closed=[...trades].filter(t=>!isOpen(t)).sort((a,b)=>new Date(a.date)-new Date(b.date));
    let cum=0;const pts=closed.map(t=>{cum+=t.pnl||0;return cum;});
    if(!pts.length)return;
    const W=c.width,H=c.height,pad=40;const maxV=Math.max(...pts,0),minV=Math.min(...pts,0),range=maxV-minV||1;
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
    for(let i=0;i<5;i++){const y=pad+i*(H-2*pad)/4;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W,y);ctx.stroke();}
    ctx.beginPath();pts.forEach((v,i)=>{const x=pad+i*(W-pad)/(pts.length-1||1);const y=H-pad-(v-minV)/range*(H-2*pad);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.strokeStyle='#34d399';ctx.lineWidth=2.5;ctx.stroke();
    const lastX=pad+(pts.length-1)*(W-pad)/(pts.length-1||1);ctx.lineTo(lastX,H-pad);ctx.lineTo(pad,H-pad);ctx.closePath();
    const grd=ctx.createLinearGradient(0,0,0,H);grd.addColorStop(0,'rgba(52,211,153,0.12)');grd.addColorStop(1,'rgba(52,211,153,0)');ctx.fillStyle=grd;ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px JetBrains Mono';ctx.textAlign='right';
    for(let i=0;i<5;i++){const v=maxV-i*range/4;ctx.fillText('$'+Math.round(v),pad-6,pad+i*(H-2*pad)/4+4);}
}

function drawTreemap(){
    const c=document.getElementById('tmCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const byInst={};trades.forEach(t=>{const k=t.instrument;if(!byInst[k])byInst[k]={pnl:0,size:0,ac:getAC(t)};byInst[k].pnl+=t.pnl||0;byInst[k].size+=Math.abs(t.shares||t.lots||t.contracts||t.investmentAmount||t.purchasePrice||1);});
    const items=Object.entries(byInst).map(([k,v])=>({name:k,pnl:v.pnl,size:Math.max(v.size,1),ac:v.ac})).sort((a,b)=>b.size-a.size);
    if(!items.length)return;
    const W=c.width,H=c.height;const totalSize=items.reduce((s,i)=>s+i.size,0)||1;
    let rects=[],x=0,y=0,rw=W,rh=H,remaining=[...items];
    while(remaining.length){
        const isWide=rw>=rh;const dim=isWide?rh:rw;let row=[],rowSize=0;
        const totalRem=remaining.reduce((s,i)=>s+i.size,0);
        for(let i=0;i<remaining.length;i++){row.push(remaining[i]);rowSize+=remaining[i].size;if(row.length>=Math.ceil(remaining.length/2)||row.length>=4)break;}
        remaining=remaining.slice(row.length);const rowFrac=rowSize/totalRem;const rowDim=isWide?rw*rowFrac:rh*rowFrac;let pos=0;
        row.forEach(item=>{const frac=item.size/rowSize;const iw=isWide?rowDim:dim*frac;const ih=isWide?dim*frac:rowDim;const ix=isWide?x:x+pos;const iy=isWide?y+pos:y;rects.push({...item,x:ix,y:iy,w:iw,h:ih});pos+=isWide?ih:iw;});
        if(isWide){x+=rowDim;rw-=rowDim;}else{y+=rowDim;rh-=rowDim;}
    }
    const maxPnl=Math.max(...rects.map(r=>Math.abs(r.pnl)),1);
    rects.forEach(r=>{const int=Math.min(Math.abs(r.pnl)/maxPnl,1)*0.6+0.15;ctx.fillStyle=r.pnl>=0?`rgba(52,211,153,${int})`:`rgba(248,113,113,${int})`;ctx.beginPath();const m=1.5;ctx.roundRect(r.x+m,r.y+m,Math.max(r.w-m*2,0),Math.max(r.h-m*2,0),6);ctx.fill();if(r.w>40&&r.h>30){ctx.fillStyle='rgba(255,255,255,0.85)';const fs=Math.min(Math.max(r.w/6,10),14);ctx.font=`600 ${fs}px Inter`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(r.name,r.x+r.w/2,r.y+r.h/2-6);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font=`500 ${Math.max(fs-2,9)}px JetBrains Mono`;ctx.fillText(fmt$(r.pnl),r.x+r.w/2,r.y+r.h/2+8);}});
}

// ‚ïê‚ïê‚ïê TRADE LOG ‚ïê‚ïê‚ïê
let logSort={col:'date',asc:false},logFilter={search:'',ac:'',dir:''};
function renderTradeLog(){
    let filtered=[...trades];
    if(logFilter.search){const q=logFilter.search.toLowerCase();filtered=filtered.filter(t=>`${t.instrument} ${(t.tags||[]).join(' ')} ${t.notes||''}`.toLowerCase().includes(q));}
    if(logFilter.ac)filtered=filtered.filter(t=>getAC(t)===logFilter.ac);
    if(logFilter.dir)filtered=filtered.filter(t=>t.direction===logFilter.dir);
    filtered.sort((a,b)=>{let v=0;if(logSort.col==='date')v=new Date(a.date)-new Date(b.date);else if(logSort.col==='pnl')v=(a.pnl||0)-(b.pnl||0);else if(logSort.col==='instrument')v=a.instrument.localeCompare(b.instrument);return logSort.asc?v:-v;});

    let h=`<div class="card"><div class="card-title">Trade Log</div>
    <div class="filters">
        <input class="flt" placeholder="üîç Search..." value="${logFilter.search}" oninput="logFilter.search=this.value;renderTradeLog()"/>
        <select class="flt" onchange="logFilter.ac=this.value;renderTradeLog()"><option value="">All Classes</option>${Object.entries(AC).map(([k,v])=>`<option value="${k}" ${logFilter.ac===k?'selected':''}>${v.icon} ${v.label}</option>`).join('')}</select>
        <select class="flt" onchange="logFilter.dir=this.value;renderTradeLog()"><option value="">All Directions</option><option ${logFilter.dir==='LONG'?'selected':''}>LONG</option><option ${logFilter.dir==='SHORT'?'selected':''}>SHORT</option></select>
        <span style="font-size:12px;color:var(--dim);align-self:center;margin-left:auto">${filtered.length} trades</span>
    </div>
    <div class="tbl-wrap"><table>
    <tr><th onclick="sortLog('date')">Date</th><th>Class</th><th onclick="sortLog('instrument')">Instrument</th><th>Dir</th><th>Status</th><th onclick="sortLog('pnl')">P&L</th><th>Tags</th></tr>
    ${filtered.map(t=>{const acl=AC[getAC(t)]||{};return`<tr>
        <td style="font-family:'JetBrains Mono';font-size:12px">${new Date(t.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
        <td><span class="pill pill-cls" style="background:${acl.color||'#888'}22;color:${acl.color||'#888'}">${acl.icon||''} ${acl.label||''}</span></td>
        <td style="font-weight:600">${t.instrument}</td>
        <td class="${t.direction==='LONG'?'dir-long':t.direction==='SHORT'?'dir-short':''}">${t.direction||'‚Äî'}</td>
        <td>${isOpen(t)?'<span class="status-open">Open</span>':'<span class="status-closed">Closed</span>'}</td>
        <td style="color:${pnlColor(t.pnl||0)};font-weight:600;font-family:'JetBrains Mono'">${isOpen(t)?'‚Äî':fmt$(t.pnl||0)}</td>
        <td>${(t.tags||[]).map(g=>`<span class="pill pill-tag">${g}</span>`).join('')}</td>
    </tr>`;}).join('')}
    </table></div></div>`;
    document.getElementById('pnl').innerHTML=h;
}
function sortLog(col){if(logSort.col===col)logSort.asc=!logSort.asc;else{logSort.col=col;logSort.asc=false;}renderTradeLog();}

// ‚ïê‚ïê‚ïê PORTFOLIO ‚ïê‚ïê‚ïê
function renderPortfolio(){
    const openTrades=trades.filter(t=>isOpen(t));
    const closedTrades=trades.filter(t=>!isOpen(t));
    const totalPnl=closedTrades.reduce((s,t)=>s+(t.pnl||0),0);
    const wins=closedTrades.filter(t=>(t.pnl||0)>0).length;

    let h=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
        <div class="card stat"><div class="lbl">Realized P&L</div><div class="val" style="color:${pnlColor(totalPnl)}">${fmt$(totalPnl)}</div></div>
        <div class="card stat"><div class="lbl">Open Positions</div><div class="val" style="color:var(--gld)">${openTrades.length}</div></div>
        <div class="card stat"><div class="lbl">Total Trades</div><div class="val" style="color:var(--cyn)">${trades.length}</div></div>
        <div class="card stat"><div class="lbl">Win Rate</div><div class="val" style="color:var(--gld)">${closedTrades.length?(wins/closedTrades.length*100).toFixed(1):0}%</div></div>
    </div>`;

    // Open positions first
    if(openTrades.length){
        h+=`<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span class="status-open" style="font-size:12px">OPEN POSITIONS</span></div><div class="pos-grid">`;
        openTrades.forEach(t=>{h+=renderPosCard(t);});
        h+=`</div></div>`;
    }

    // Closed by asset class
    const groups={};closedTrades.forEach(t=>{const ac=getAC(t);if(!groups[ac])groups[ac]=[];groups[ac].push(t);});
    Object.entries(groups).sort((a,b)=>b[1].reduce((s,t)=>s+(t.pnl||0),0)-a[1].reduce((s,t)=>s+(t.pnl||0),0)).forEach(([ac,items])=>{
        const acl=AC[ac]||{};const clsPnl=items.reduce((s,t)=>s+(t.pnl||0),0);
        h+=`<div style="margin-bottom:20px">
            <div class="ac-badge" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none';this.querySelector('.ac-arrow').classList.toggle('collapsed')">
                <span class="ac-dot" style="background:${acl.color||'#888'}"></span>${acl.icon||''} ${acl.label||ac}
                <span style="color:var(--mut);font-weight:400">${items.length} trades</span>
                <span style="color:${pnlColor(clsPnl)};font-family:'JetBrains Mono';font-size:12px;margin-left:8px">${fmt$(clsPnl)}</span>
                <span class="ac-arrow">‚ñº</span>
            </div><div class="pos-grid">`;
        items.forEach(t=>{h+=renderPosCard(t);});
        h+=`</div></div>`;
    });
    document.getElementById('pnl').innerHTML=h;enrichOpenPositions();
}

function renderPosCard(t){
    const acl=AC[getAC(t)]||{};const open=isOpen(t);
    let details='';
    const ac=getAC(t);
    if(ac==='stocks') details=`<div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div><div class="pos-detail"><span class="pd-lbl">${open?'Shares':'Exit'}</span><span class="pd-val">${open?t.shares:t.exit}</span></div><div class="pos-detail"><span class="pd-lbl">${open?'':'Shares'}</span><span class="pd-val">${open?'':t.shares}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='options') details=`<div class="pos-detail"><span class="pd-lbl">${t.optionType} $${t.strike}</span><span class="pd-val">√ó${t.contracts}</span></div><div class="pos-detail"><span class="pd-lbl">Premium</span><span class="pd-val">$${t.premium}${t.exitPremium?' ‚Üí $'+t.exitPremium:''}</span></div><div class="pos-detail"><span class="pd-lbl">Expiry</span><span class="pd-val">${t.expiry||'‚Äî'}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='forex') details=`<div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div><div class="pos-detail"><span class="pd-lbl">Exit</span><span class="pd-val">${open?'‚Äî':t.exit}</span></div><div class="pos-detail"><span class="pd-lbl">Lots</span><span class="pd-val">${t.lots}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='commodities') details=`<div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div><div class="pos-detail"><span class="pd-lbl">Exit</span><span class="pd-val">${open?'‚Äî':t.exit}</span></div><div class="pos-detail"><span class="pd-lbl">Lots</span><span class="pd-val">${t.lots}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='indices') details=`<div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div><div class="pos-detail"><span class="pd-lbl">Exit</span><span class="pd-val">${open?'‚Äî':t.exit}</span></div><div class="pos-detail"><span class="pd-lbl">Contracts</span><span class="pd-val">${t.contracts}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='futures') details=`<div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div><div class="pos-detail"><span class="pd-lbl">Exit</span><span class="pd-val">${open?'‚Äî':t.exit}</span></div><div class="pos-detail"><span class="pd-lbl">Contracts</span><span class="pd-val">${t.contracts}</span></div><div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${open?'‚Äî':fmt$(t.pnl)}</span></div>`;
    else if(ac==='angel') details=`<div class="pos-detail"><span class="pd-lbl">Invested</span><span class="pd-val">${fmt$(t.investmentAmount)}</span></div><div class="pos-detail"><span class="pd-lbl">Equity</span><span class="pd-val">${t.equityPct}%</span></div><div class="pos-detail"><span class="pd-lbl">Status</span><span class="pd-val" style="color:${t.status==='active'?'var(--gld)':t.status==='exited'?'var(--grn)':'var(--red)'}">${t.status}</span></div><div class="pos-detail"><span class="pd-lbl">Return</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${t.exitValuation?fmt$(t.pnl):'‚Äî'}</span></div>`;
    else if(ac==='realestate') details=`<div class="pos-detail"><span class="pd-lbl">Purchase</span><span class="pd-val">${fmt$(t.purchasePrice)}</span></div><div class="pos-detail"><span class="pd-lbl">Current</span><span class="pd-val">${fmt$(t.currentValue)}</span></div><div class="pos-detail"><span class="pd-lbl">${t.generatesRent?'Rent/mo':'Type'}</span><span class="pd-val">${t.generatesRent?fmt$(t.monthlyRent):t.propertyType}</span></div><div class="pos-detail"><span class="pd-lbl">Unrealized</span><span class="pd-val" style="color:${pnlColor(t.pnl||0)}">${fmt$(t.pnl)}</span></div>`;

    const liveTickerAttr=(['stocks','options','indices'].includes(ac)&&INST.stocks?.includes(t.instrument))?` data-live-ticker="${t.instrument}"`:'';
    return`<div class="card pos-card">
        <div class="pos-header"><span class="pos-inst">${t.instrument}</span>
        ${open?'<span class="status-open">OPEN</span>':t.direction?`<span class="pos-dir ${t.direction.toLowerCase()}">${t.direction}</span>`:`<span class="pos-dir hold">HOLD</span>`}
        <span class="live-badge" style="display:none;align-items:center;gap:4px;margin-left:auto;font-size:12px;padding:3px 8px;background:var(--s1);border:1px solid var(--brd);border-radius:8px"${liveTickerAttr}></span></div>
        <div style="font-size:10px;color:${acl.color||'#888'};margin-bottom:8px">${acl.icon||''} ${acl.label||''}</div>
        <div class="pos-details">${details}</div>
        ${(t.tags||[]).length?`<div class="pos-tags">${t.tags.map(g=>`<span class="pill pill-tag">${g}</span>`).join('')}</div>`:''}
    </div>`;
}

// ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
let calMonth=1,calYear=2026;
function renderCalendar(){
    const dailyPnl={};trades.filter(t=>!isOpen(t)).forEach(t=>{const d=new Date(t.date);const k=d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();if(!dailyPnl[k])dailyPnl[k]={pnl:0,cnt:0};dailyPnl[k].pnl+=(t.pnl||0);dailyPnl[k].cnt++;});
    const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
    const first=new Date(calYear,calMonth,1);const daysInMonth=new Date(calYear,calMonth+1,0).getDate();const startDay=first.getDay();const today=new Date();
    let h=`<div class="card"><div class="cal-nav"><button onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar()">‚Üê Prev</button><div class="month">${months[calMonth]} ${calYear}</div><button onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar()">Next ‚Üí</button></div><div class="cal-grid">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="cal-hdr">${d}</div>`).join('')}`;
    for(let i=0;i<startDay;i++)h+=`<div class="cal-day empty"></div>`;
    for(let d=1;d<=daysInMonth;d++){const key=calYear+'-'+(calMonth+1)+'-'+d;const data=dailyPnl[key];const isToday=today.getDate()===d&&today.getMonth()===calMonth&&today.getFullYear()===calYear;let bg='transparent';if(data){const int=Math.min(Math.abs(data.pnl)/1500,1);bg=data.pnl>=0?`rgba(52,211,153,${0.05+int*0.2})`:`rgba(248,113,113,${0.05+int*0.2})`;}
    h+=`<div class="cal-day${isToday?' today':''}" style="background:${bg}"><div class="d-num">${d}</div>${data?`<div class="d-pnl" style="color:${pnlColor(data.pnl)}">${fmt$(data.pnl)}</div><div class="d-cnt">${data.cnt} trade${data.cnt>1?'s':''}</div>`:''}</div>`;}
    h+=`</div></div>`;document.getElementById('pnl').innerHTML=h;
}

// ‚ïê‚ïê‚ïê ANALYTICS ‚ïê‚ïê‚ïê
function renderAnalytics(){
    const closed=trades.filter(t=>!isOpen(t));const wins=closed.filter(t=>(t.pnl||0)>0),losses=closed.filter(t=>(t.pnl||0)<=0);
    let curWin=0,maxWin=0,curLoss=0,maxLoss=0;
    [...closed].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t=>{if(t.pnl>0){curWin++;curLoss=0;maxWin=Math.max(maxWin,curWin);}else{curLoss++;curWin=0;maxLoss=Math.max(maxLoss,curLoss);}});
    let h=`<div class="streak-row">
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${curWin}</div><div class="s-lbl">Current Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${maxWin}</div><div class="s-lbl">Max Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${curLoss}</div><div class="s-lbl">Current Loss Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${maxLoss}</div><div class="s-lbl">Max Loss Streak</div></div>
    </div>`;
    h+=`<div class="ana-grid"><div class="card"><div class="card-title">Win / Loss</div><canvas id="wlCanvas" height="220"></canvas></div><div class="card"><div class="card-title">By Asset Class</div><canvas id="acCanvas" height="220"></canvas></div></div>`;
    h+=`<div class="card" style="margin-bottom:14px"><div class="card-title">Bubble Chart ‚Äî Instruments</div><canvas id="bubbleCanvas" height="320"></canvas></div>`;
    document.getElementById('pnl').innerHTML=h;
    setTimeout(()=>{drawDonut(wins.length,losses.length);drawACChart();drawBubble();},60);
}

function drawDonut(w,l){
    const c=document.getElementById('wlCanvas');if(!c)return;const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const cx=c.width/2,cy=c.height/2+10,r=70,total=w+l||1;
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+w/total*Math.PI*2);ctx.lineWidth=22;ctx.strokeStyle='#34d399';ctx.stroke();
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2+w/total*Math.PI*2,-Math.PI/2+Math.PI*2);ctx.lineWidth=22;ctx.strokeStyle='#f87171';ctx.stroke();
    ctx.fillStyle='#f5f5f7';ctx.font='bold 22px JetBrains Mono';ctx.textAlign='center';ctx.fillText((w/total*100).toFixed(0)+'%',cx,cy+2);
    ctx.fillStyle='rgba(255,255,255,0.35)';ctx.font='12px Inter';ctx.fillText('Win Rate',cx,cy+22);
}

function drawACChart(){
    const c=document.getElementById('acCanvas');if(!c)return;const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const byAC={};trades.filter(t=>!isOpen(t)).forEach(t=>{const ac=getAC(t);if(!byAC[ac])byAC[ac]={pnl:0,cnt:0};byAC[ac].pnl+=(t.pnl||0);byAC[ac].cnt++;});
    const items=Object.entries(byAC).sort((a,b)=>b[1].pnl-a[1].pnl);
    const W=c.width,H=c.height,pad=100,barH=22,gap=8;const maxAbs=Math.max(...items.map(s=>Math.abs(s[1].pnl)),1);
    const midX=pad+(W-pad-40)/2;
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.beginPath();ctx.moveTo(midX,0);ctx.lineTo(midX,H);ctx.stroke();
    items.forEach(([ac,data],i)=>{
        const acl=AC[ac]||{};const y=20+i*(barH+gap);const barW=Math.abs(data.pnl)/maxAbs*(W-pad-40)/2;
        const x=data.pnl>=0?midX:midX-barW;
        ctx.fillStyle=acl.color||'#888';ctx.globalAlpha=0.5;ctx.beginPath();ctx.roundRect(x,y,barW,barH,4);ctx.fill();ctx.globalAlpha=1;
        ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='11px Inter';ctx.textAlign='right';ctx.fillText(`${acl.icon||''} ${acl.label||ac}`,pad-8,y+15);
        ctx.textAlign=data.pnl>=0?'left':'right';ctx.fillStyle=data.pnl>=0?'#34d399':'#f87171';ctx.font='10px JetBrains Mono';
        ctx.fillText(fmt$(data.pnl),data.pnl>=0?midX+barW+6:midX-barW-6,y+15);
    });
}

function drawBubble(){
    const c=document.getElementById('bubbleCanvas');if(!c)return;const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const W=c.width,H=c.height,pad=60;
    const byInst={};trades.filter(t=>!isOpen(t)).forEach(t=>{if(!byInst[t.instrument])byInst[t.instrument]={wins:0,total:0,pnl:0,ac:getAC(t)};byInst[t.instrument].total++;byInst[t.instrument].pnl+=(t.pnl||0);if((t.pnl||0)>0)byInst[t.instrument].wins++;});
    const items=Object.entries(byInst).map(([k,v])=>({name:k,winRate:v.total?v.wins/v.total*100:0,avgPnl:v.pnl/v.total,trades:v.total,ac:v.ac}));
    if(!items.length)return;const maxTrades=Math.max(...items.map(i=>i.trades));const maxPnl=Math.max(...items.map(i=>Math.abs(i.avgPnl)),1);
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,H-pad);ctx.lineTo(W-20,H-pad);ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.2)';ctx.font='10px Inter';ctx.textAlign='center';ctx.fillText('Win Rate %',W/2,H-10);
    const midY=(pad+H-pad)/2;ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W-20,midY);ctx.stroke();
    items.forEach(item=>{const x=pad+(item.winRate/100)*(W-pad-20);const y=midY-(item.avgPnl/maxPnl)*((H-2*pad)/2)*0.8;const r=Math.max(6,Math.min(item.trades/maxTrades*30,30));
    const acl=AC[item.ac]||{};const color=acl.color||'#888';
    ctx.globalAlpha=0.35;ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=0.8;ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;
    if(r>10){ctx.fillStyle='rgba(255,255,255,0.8)';ctx.font=`${Math.max(8,Math.min(r/2,11))}px Inter`;ctx.textAlign='center';ctx.fillText(item.name,x,y+3);}});
    let lx=pad;Object.entries(AC).forEach(([k,v])=>{if(!Object.values(byInst).some(i=>i.ac===k))return;ctx.fillStyle=v.color;ctx.beginPath();ctx.arc(lx+5,20,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='10px Inter';ctx.textAlign='left';ctx.fillText(v.label,lx+13,24);lx+=ctx.measureText(v.label).width+28;});
}

// ‚ïê‚ïê‚ïê INLINE TOGGLES (no re-render) ‚ïê‚ïê‚ïê
function toggleTag(btn,t){if(addTags.has(t)){addTags.delete(t);btn.classList.remove('sel');}else{addTags.add(t);btn.classList.add('sel');}}
function pickEmo(btn,e){addEmo=e;btn.closest('.emo-row').querySelectorAll('.emo-btn').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');}
function pickRating(n){addRating=n;document.querySelectorAll('.stars .star').forEach((b,i)=>b.classList.toggle('lit',i<n));}

// ‚ïê‚ïê‚ïê LIVE PRICE FEED (Yahoo Finance via corsproxy) ‚ïê‚ïê‚ïê
const priceCache={};
async function fetchPrice(symbol){
    if(priceCache[symbol]&&Date.now()-priceCache[symbol].ts<60000)return priceCache[symbol];
    try{
        const r=await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=1d&range=5d`);
        const j=await r.json();
        const meta=j.chart?.result?.[0]?.meta;
        if(!meta)return null;
        const price=meta.regularMarketPrice;
        const prevClose=meta.chartPreviousClose||meta.previousClose;
        const change=price-prevClose;
        const changePct=(change/prevClose*100);
        const result={price,change,changePct,currency:meta.currency||'USD',ts:Date.now()};
        priceCache[symbol]=result;
        return result;
    }catch(e){console.warn('Price fetch failed for',symbol,e);return null;}
}

// Show live price badge on open positions in portfolio
async function enrichOpenPositions(){
    const badges=document.querySelectorAll('[data-live-ticker]');
    for(const el of badges){
        const ticker=el.dataset.liveTicker;
        const data=await fetchPrice(ticker);
        if(data){
            el.innerHTML=`<span style="font-family:'JetBrains Mono';font-weight:600">$${data.price.toFixed(2)}</span> <span style="font-size:11px;color:${data.change>=0?'var(--grn)':'var(--red)'}">${data.change>=0?'+':''}${data.changePct.toFixed(2)}%</span>`;
            el.style.display='inline-flex';
        }
    }
}

// ‚ïê‚ïê‚ïê USER MENU ‚ïê‚ïê‚ïê
function toggleUserMenu(){const m=document.getElementById('user-menu');m.style.display=m.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{if(!e.target.closest('#user-wrap')){const m=document.getElementById('user-menu');if(m)m.style.display='none';}});

// ‚ïê‚ïê‚ïê SIGN OUT ‚ïê‚ïê‚ïê
async function handleSignOut(){
    await sb.auth.signOut();
    localStorage.removeItem('tj-trades-v2');
    window.location.href='auth.html';
}

// ‚ïê‚ïê‚ïê EARNINGS CALENDAR DATA (US Markets) ‚ïê‚ïê‚ïê
const EARNINGS_CAL=[
    {date:'2026-03-04',ticker:'CRM',name:'Salesforce',time:'AMC'},
    {date:'2026-03-04',ticker:'CRWD',name:'CrowdStrike',time:'AMC'},
    {date:'2026-03-05',ticker:'AVGO',name:'Broadcom',time:'AMC'},
    {date:'2026-03-05',ticker:'MRVL',name:'Marvell Tech',time:'AMC'},
    {date:'2026-03-06',ticker:'COST',name:'Costco',time:'AMC'},
    {date:'2026-03-06',ticker:'BJ',name:'BJ\'s Wholesale',time:'BMO'},
    {date:'2026-03-10',ticker:'ORCL',name:'Oracle',time:'AMC'},
    {date:'2026-03-11',ticker:'ADBE',name:'Adobe',time:'AMC'},
    {date:'2026-03-12',ticker:'DG',name:'Dollar General',time:'BMO'},
    {date:'2026-03-13',ticker:'ULTA',name:'Ulta Beauty',time:'AMC'},
    {date:'2026-03-17',ticker:'XPEV',name:'XPeng',time:'BMO'},
    {date:'2026-03-18',ticker:'NKE',name:'Nike',time:'AMC'},
    {date:'2026-03-19',ticker:'GIS',name:'General Mills',time:'BMO'},
    {date:'2026-03-20',ticker:'ACN',name:'Accenture',time:'BMO'},
    {date:'2026-03-20',ticker:'FDX',name:'FedEx',time:'AMC'},
    {date:'2026-03-25',ticker:'GME',name:'GameStop',time:'AMC'},
    {date:'2026-03-26',ticker:'PAYX',name:'Paychex',time:'BMO'},
    {date:'2026-03-27',ticker:'LULU',name:'Lululemon',time:'AMC'},
];

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
(async()=>{
    const authed=await checkAuth();
    if(!authed)return;
    // Update user button
    const ub=document.getElementById('user-btn');
    if(ub)ub.textContent='üë§ '+(currentUser.username||currentUser.email?.split('@')[0]||'User');
    // Load from DB
    await loadTradesFromDB();
    initNav();render();
    // Auto-open Add Trade if user has no trades (first visit after signup)
    if(trades.length===0) openSheet();
})();
document.addEventListener('keydown',e=>{if(document.querySelector('.sheet-bg.show')){if(e.key==='Escape')closeSheet();return;}if(e.key>='1'&&e.key<='5')switchTab(+e.key-1);if(e.key==='n'||e.key==='N')openSheet();});
</script>
</body>
</html>
