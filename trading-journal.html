<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tradyom Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #000000;
    --s1: rgba(255,255,255,0.04);
    --s2: rgba(255,255,255,0.07);
    --brd: rgba(255,255,255,0.08);
    --brd2: rgba(255,255,255,0.12);
    --txt: #f5f5f7;
    --dim: rgba(255,255,255,0.55);
    --mut: rgba(255,255,255,0.3);
    --grn: #34d399;
    --red: #f87171;
    --cyn: #67e8f9;
    --gld: #fbbf24;
    --pur: #c084fc;
    --blu: #60a5fa;
    --grn-bg: rgba(52,211,153,0.1);
    --red-bg: rgba(248,113,113,0.1);
    --glass: rgba(20,20,20,0.75);
    --radius: 16px;
    --radius-sm: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--txt);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}
body::before {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse 60% 50% at 30% 0%, rgba(52,211,153,0.04), transparent 60%),
                radial-gradient(ellipse 50% 40% at 70% 100%, rgba(103,232,249,0.03), transparent 60%);
    pointer-events: none;
}
.app {
    max-width: 1320px;
    margin: 0 auto;
    padding: 20px 24px 100px;
    position: relative; z-index: 1;
}

/* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0 20px;
    margin-bottom: 20px;
}
.logo {
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--txt);
}
.logo span { color: var(--grn); }

/* ‚îÄ‚îÄ‚îÄ Segmented Control (iOS-style) ‚îÄ‚îÄ‚îÄ */
.seg-ctrl {
    display: flex;
    background: var(--s1);
    border: 1px solid var(--brd);
    border-radius: 12px;
    padding: 3px;
    gap: 2px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.seg-btn {
    padding: 8px 18px;
    border: none;
    background: transparent;
    color: var(--dim);
    font-size: 13px;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.25s ease;
    white-space: nowrap;
    position: relative;
}
.seg-btn:hover { color: var(--txt); }
.seg-btn.on {
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

/* ‚îÄ‚îÄ‚îÄ Glass Cards ‚îÄ‚îÄ‚îÄ */
.card {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--brd);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.3s ease;
}
.card:hover { border-color: var(--brd2); }
.card-title {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 14px;
}

/* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
.stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}
.stat { text-align: center; padding: 18px 12px; }
.stat .val {
    font-size: 1.6rem;
    font-weight: 700;
    font-family: 'JetBrains Mono';
    margin: 6px 0 4px;
    letter-spacing: -0.5px;
}
.stat .lbl {
    font-size: 11px;
    color: var(--mut);
    font-weight: 500;
}

/* ‚îÄ‚îÄ‚îÄ Panels ‚îÄ‚îÄ‚îÄ */
.pnl { display: none; }
.pnl.on { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ‚îÄ‚îÄ‚îÄ 2-col Layout ‚îÄ‚îÄ‚îÄ */
.row2 { display: grid; grid-template-columns: 1.5fr 1fr; gap: 14px; margin-bottom: 16px; }

/* ‚îÄ‚îÄ‚îÄ Trade Log Table ‚îÄ‚îÄ‚îÄ */
.tbl-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th {
    font-size: 10px; letter-spacing: 0.5px; color: var(--mut); text-transform: uppercase;
    padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--brd);
    cursor: pointer; white-space: nowrap; user-select: none; font-weight: 600;
}
th:hover { color: var(--cyn); }
td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); white-space: nowrap; }
tr { transition: background 0.15s; }
tr:hover td { background: rgba(255,255,255,0.02); }
.pill { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: 500; }
.pill-tag { background: rgba(192,132,252,0.1); color: var(--pur); }
.dir-long { color: var(--grn); font-weight: 600; }
.dir-short { color: var(--red); font-weight: 600; }

/* ‚îÄ‚îÄ‚îÄ Filters ‚îÄ‚îÄ‚îÄ */
.filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
.flt {
    padding: 8px 14px; background: var(--s1); border: 1px solid var(--brd);
    border-radius: var(--radius-sm); color: var(--dim); font-size: 13px;
    font-family: inherit; outline: none; transition: all 0.2s;
}
.flt:focus { border-color: var(--grn); color: var(--txt); }
select.flt { cursor: pointer; }

/* ‚îÄ‚îÄ‚îÄ Floating Action Button ‚îÄ‚îÄ‚îÄ */
.fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--grn);
    color: #000;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    box-shadow: 0 4px 24px rgba(52,211,153,0.3);
    z-index: 100;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.fab:hover { transform: scale(1.08); box-shadow: 0 6px 32px rgba(52,211,153,0.4); }
.fab:active { transform: scale(0.95); }

/* ‚îÄ‚îÄ‚îÄ Modal / Bottom Sheet ‚îÄ‚îÄ‚îÄ */
.sheet-bg {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 200;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
}
.sheet-bg.show { display: flex; }
.sheet {
    background: #111;
    border: 1px solid var(--brd2);
    border-radius: 20px;
    padding: 32px;
    width: 90%;
    max-width: 520px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
.sheet-close {
    position: absolute; top: 16px; right: 16px;
    background: var(--s2); border: none; color: var(--dim);
    width: 32px; height: 32px; border-radius: 50%;
    font-size: 18px; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
}
.sheet-close:hover { background: var(--brd2); color: var(--txt); }
.sheet h2 {
    font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.3px;
}
.sheet .sub { font-size: 13px; color: var(--dim); margin-bottom: 24px; }

/* ‚îÄ‚îÄ‚îÄ Form Elements (Apple-style) ‚îÄ‚îÄ‚îÄ */
.fg { margin-bottom: 16px; }
.fg label {
    display: block; font-size: 11px; font-weight: 600; color: var(--dim);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
}
.fg input, .fg select, .fg textarea {
    width: 100%;
    padding: 12px 16px;
    background: var(--s1);
    border: 1px solid var(--brd);
    border-radius: var(--radius-sm);
    color: var(--txt);
    font-size: 15px;
    font-family: inherit;
    outline: none;
    transition: all 0.2s;
}
.fg input:focus, .fg select:focus, .fg textarea:focus { border-color: var(--grn); background: var(--s2); }
.fg textarea { resize: vertical; min-height: 70px; }
.fg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.fg-row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* Direction Buttons */
.dir-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.dir-btn {
    padding: 14px;
    border: 2px solid var(--brd);
    border-radius: var(--radius-sm);
    background: transparent;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.25s ease;
}
.dir-btn.long { color: var(--grn); }
.dir-btn.short { color: var(--red); }
.dir-btn.long.sel { background: var(--grn-bg); border-color: var(--grn); }
.dir-btn.short.sel { background: var(--red-bg); border-color: var(--red); }

/* Live P&L Preview */
.live-pnl {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    padding: 14px 16px; margin-bottom: 16px;
    background: var(--s1); border: 1px solid var(--brd); border-radius: var(--radius-sm);
}
.lp-item { text-align: center; }
.lp-val { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono'; }
.lp-lbl { font-size: 10px; color: var(--mut); margin-top: 2px; }

/* Tags */
.tags-row { display: flex; flex-wrap: wrap; gap: 6px; }
.tag-btn {
    padding: 6px 14px; border-radius: 20px; border: 1px solid var(--brd);
    background: transparent; color: var(--dim); font-size: 12px;
    cursor: pointer; font-family: inherit; transition: all 0.2s;
}
.tag-btn.sel { background: rgba(192,132,252,0.12); border-color: rgba(192,132,252,0.3); color: var(--pur); }

/* Emotions & Stars */
.emo-row { display: flex; gap: 8px; }
.emo-btn {
    font-size: 24px; cursor: pointer; padding: 6px; border: 2px solid transparent;
    border-radius: 12px; background: none; transition: all 0.2s;
}
.emo-btn.sel { border-color: var(--gld); background: rgba(251,191,36,0.08); }
.stars { display: flex; gap: 4px; }
.star { font-size: 22px; cursor: pointer; color: var(--mut); transition: color 0.15s; background: none; border: none; }
.star.lit { color: var(--gld); }

/* Save Button */
.save-btn {
    width: 100%; padding: 14px; background: var(--grn); color: #000;
    border: none; border-radius: var(--radius-sm); font-size: 15px;
    font-weight: 700; cursor: pointer; font-family: inherit;
    transition: all 0.2s; margin-top: 8px;
}
.save-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.save-btn:active { transform: translateY(0); }

/* ‚îÄ‚îÄ‚îÄ Portfolio Cards ‚îÄ‚îÄ‚îÄ */
.pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
.pos-card {
    padding: 16px; cursor: default;
    transition: all 0.25s ease;
}
.pos-card:hover { transform: translateY(-2px); border-color: var(--brd2); }
.pos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.pos-inst { font-size: 16px; font-weight: 700; }
.pos-dir {
    font-size: 10px; font-weight: 700; padding: 3px 10px;
    border-radius: 20px; text-transform: uppercase;
}
.pos-dir.long { background: var(--grn-bg); color: var(--grn); }
.pos-dir.short { background: var(--red-bg); color: var(--red); }
.pos-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
.pos-detail { display: flex; flex-direction: column; gap: 2px; }
.pos-detail .pd-lbl { color: var(--mut); font-size: 10px; }
.pos-detail .pd-val { font-family: 'JetBrains Mono'; font-weight: 500; }
.pos-tags { margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap; }

/* ‚îÄ‚îÄ‚îÄ Treemap ‚îÄ‚îÄ‚îÄ */
.treemap-wrap { position: relative; border-radius: var(--radius-sm); overflow: hidden; }

/* ‚îÄ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ‚îÄ */
.cal-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 16px; }
.cal-nav button {
    background: var(--s1); border: 1px solid var(--brd); color: var(--dim);
    padding: 8px 14px; border-radius: var(--radius-sm); cursor: pointer;
    font-family: inherit; font-size: 13px; transition: all 0.2s;
}
.cal-nav button:hover { border-color: var(--cyn); color: var(--cyn); }
.cal-nav .month { font-size: 1.1rem; font-weight: 700; min-width: 180px; text-align: center; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.cal-hdr { text-align: center; font-size: 11px; color: var(--mut); padding: 8px; font-weight: 600; }
.cal-day {
    min-height: 72px; background: var(--s1); border: 1px solid rgba(255,255,255,0.04);
    border-radius: var(--radius-sm); padding: 8px; font-size: 11px; transition: all 0.2s;
}
.cal-day:hover { border-color: var(--brd2); }
.cal-day .d-num { font-weight: 600; color: var(--dim); margin-bottom: 4px; }
.cal-day .d-pnl { font-size: 14px; font-weight: 700; font-family: 'JetBrains Mono'; }
.cal-day .d-cnt { font-size: 9px; color: var(--mut); }
.cal-day.today { border-color: var(--cyn); }
.cal-day.empty { background: transparent; border-color: transparent; }

/* ‚îÄ‚îÄ‚îÄ Analytics ‚îÄ‚îÄ‚îÄ */
.ana-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
.streak-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 14px; }
.streak { text-align: center; padding: 14px; }
.streak .s-val { font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono'; }
.streak .s-lbl { font-size: 10px; color: var(--mut); margin-top: 4px; }

/* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
.toast {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(30px);
    background: var(--grn); color: #000; padding: 12px 24px;
    border-radius: 30px; font-size: 14px; font-weight: 600;
    z-index: 9999; opacity: 0; transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 4px 20px rgba(52,211,153,0.3);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

canvas { border-radius: var(--radius-sm); }

/* ‚îÄ‚îÄ‚îÄ Asset class badges ‚îÄ‚îÄ‚îÄ */
.ac-badge {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 13px; font-weight: 600; color: var(--txt);
    padding: 8px 0; margin-bottom: 8px; cursor: pointer; user-select: none;
}
.ac-badge .ac-dot { width: 8px; height: 8px; border-radius: 50%; }
.ac-badge .ac-arrow { color: var(--mut); font-size: 10px; transition: transform 0.2s; }
.ac-badge .ac-arrow.collapsed { transform: rotate(-90deg); }

/* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
@media (max-width: 768px) {
    .app { padding: 14px 14px 100px; }
    .header { flex-direction: column; gap: 14px; align-items: flex-start; }
    .seg-ctrl { width: 100%; }
    .seg-btn { padding: 7px 14px; font-size: 12px; }
    .stats { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .stat .val { font-size: 1.2rem; }
    .stat { padding: 14px 8px; }
    .row2 { grid-template-columns: 1fr; }
    .ana-grid { grid-template-columns: 1fr; }
    .streak-row { grid-template-columns: repeat(2, 1fr); }
    .pos-grid { grid-template-columns: 1fr; }
    .filters { flex-direction: column; }
    .flt { width: 100%; }
    .sheet { width: 100%; max-width: 100%; border-radius: 20px 20px 0 0;
        position: fixed; bottom: 0; left: 0; right: 0; max-height: 85vh;
        animation: sheetUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .fab { bottom: 20px; right: 20px; width: 52px; height: 52px; font-size: 26px; }
}
@media (max-width: 480px) {
    .app { padding: 10px 10px 90px; }
    .seg-btn { padding: 6px 10px; font-size: 11px; }
    .stats { grid-template-columns: 1fr 1fr; gap: 6px; }
    .stat .val { font-size: 1rem; }
    .stat .lbl { font-size: 9px; }
    .card { padding: 14px; border-radius: 14px; }
    .fg-row, .fg-row3 { grid-template-columns: 1fr; }
    .cal-day { min-height: 50px; padding: 5px; }
    .cal-day .d-pnl { font-size: 12px; }
    table { font-size: 11px; }
    th, td { padding: 7px 8px; }
}
</style>
</head>
<body>
<div class="app">
<div class="header">
    <div class="logo">Tradyom<span>.</span>Journal</div>
    <div class="seg-ctrl" id="nav"></div>
</div>
<div id="panels"></div>
</div>

<button class="fab" onclick="openSheet()" title="Add Trade">+</button>
<div class="toast" id="toast"></div>

<!-- Add Trade Sheet -->
<div class="sheet-bg" id="sheetBg" onclick="closeSheet()">
<div class="sheet" onclick="event.stopPropagation()">
    <button class="sheet-close" onclick="closeSheet()">√ó</button>
    <h2>New Trade</h2>
    <div class="sub">Record your position</div>
    <div id="sheetForm"></div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA & INSTRUMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const INSTRUMENTS=["AAPL","AAVEUSD","ABBV","ABNB","ABT","ACN","ADAUSD","ADBE","ADI","ADP","AMAT","AMD","AMGN","AMT","AMZN","ANSS","AON","ATOMUSD","AUDJPY","AUDUSD","AUS200","AVAXUSD","AVGO","AXP","BA","BAC","BIIB","BKNG","BKR","BLK","BMY","BNBUSD","BRENTUSD","BRK.B","BTCUSD","CAT","CB","CCEP","CDNS","CDW","CEG","CI","CL","CMCSA","CME","COPPERUSD","COST","CPRT","CRM","CRWD","CSCO","CSX","CTAS","CTSH","CVX","DASH","DDOG","DE","DHR","DIS","DLTR","DOGEUSD","DOTUSD","DOW","DUK","DXCM","EA","EMR","ETHUSD","EURAUD","EURCHF","EURGBP","EURJPY","EURUSD","EXC","F","FANG","FAST","FDX","FRA40","FTNT","GBPAUD","GBPCAD","GBPJPY","GBPUSD","GE","GEHC","GER40","GFS","GILD","GM","GOOG","GOOGL","GS","HD","HK50","HON","IBM","ICE","IDXX","ILMN","INTC","INTU","ISRG","ITW","JNJ","JPM","JPN225","KDP","KHC","KLAC","KO","LCID","LIN","LINKUSD","LLY","LOW","LRCX","LULU","MA","MAR","MATICUSD","MCD","MCHP","MCO","MDB","MDLZ","MELI","META","MMC","MMM","MNST","MRK","MRNA","MRVL","MS","MSFT","MU","NAS100","NATGASUSD","NEARUSD","NEE","NFLX","NKE","NSC","NVDA","NXPI","NZDUSD","ODFL","ON","ORLY","PANW","PAYX","PCAR","PEP","PFE","PG","PLD","PM","PNC","PYPL","QCOM","REGN","RIVN","ROP","ROST","RTX","SBUX","SCHW","SHW","SIRI","SNPS","SO","SOLUSD","SPGI","SPLK","SPX500","SYK","T","TEAM","TGT","TJX","TMO","TMUS","TRV","TSLA","TTD","TXN","UK100","UNH","UNIUSD","UNP","UPS","US30","USB","USDCAD","USDCHF","USDHKD","USDJPY","USDMXN","USDSGD","USDTRY","USDZAR","V","VIX","VRSK","VRTX","VZ","WBA","WBD","WDAY","WELL","WM","WMT","WTIUSD","XAGUSD","XAUUSD","XEL","XOM","XPDUSD","XPTUSD","XRPUSD","ZS"];
const TAGS=['breakout','trend','scalp','swing','news','reversal','support','resistance'];
const EMOTIONS=['üòé','üò∞','üòê','üî•','üßä'];
const FOREX=['EURUSD','GBPUSD','USDJPY','AUDUSD','USDCAD','USDCHF','NZDUSD','EURGBP','EURJPY','GBPJPY','AUDJPY','EURCHF','EURAUD','GBPAUD','GBPCAD','USDSGD','USDHKD','USDTRY','USDMXN','USDZAR'];
const CRYPTO=['BTCUSD','ETHUSD','SOLUSD','XRPUSD','BNBUSD','ADAUSD','DOTUSD','AVAXUSD','DOGEUSD','MATICUSD','LINKUSD','UNIUSD','AAVEUSD','ATOMUSD','NEARUSD'];
const COMMS=['XAUUSD','XAGUSD','XPTUSD','XPDUSD','WTIUSD','BRENTUSD','NATGASUSD','COPPERUSD'];
const IDX=['SPX500','NAS100','US30','UK100','GER40','JPN225','AUS200','FRA40','HK50','VIX'];
const AC_COLORS={Stocks:'#60a5fa',Forex:'#67e8f9',Crypto:'#fbbf24',Commodities:'#fb923c',Indices:'#c084fc'};
function getClass(s){if(FOREX.includes(s))return'Forex';if(CRYPTO.includes(s))return'Crypto';if(COMMS.includes(s))return'Commodities';if(IDX.includes(s))return'Indices';return'Stocks';}

function seedTrades(){
    const trades=[];const base=new Date(2026,1,1);
    const prices={AAPL:228,META:680,AMZN:218,TSLA:340,NVDA:890,MSFT:420,GOOG:175,XAUUSD:2920,EURUSD:1.042,GBPUSD:1.263,BTCUSD:96500,ETHUSD:2780,SPX500:6050,NAS100:21500,SOLUSD:148};
    for(let i=0;i<40;i++){
        const inst=INSTRUMENTS[Math.floor(Math.random()*INSTRUMENTS.length)];
        const dir=Math.random()>0.45?'LONG':'SHORT';
        const win=Math.random()<0.55;
        const d=new Date(base.getTime()+Math.random()*26*86400000);
        const ep=(prices[inst]||100+Math.random()*200)*(1+(Math.random()-0.5)*0.02);
        const pct=(Math.random()*0.03+0.002)*(win?(dir==='LONG'?1:-1):(dir==='LONG'?-1:1));
        const xp=ep*(1+pct);
        const sz=inst.includes('USD')&&!inst.includes('BTC')&&!inst.includes('ETH')?(Math.floor(Math.random()*5)+1)*0.1:Math.floor(Math.random()*20)+1;
        const mult=FOREX.includes(inst)?100000:(CRYPTO.includes(inst)?1:100);
        const pnl=Math.round((dir==='LONG'?xp-ep:ep-xp)*sz*mult);
        const finalPnl=Math.abs(pnl)>3000?Math.round(pnl/8):pnl;
        const durH=Math.floor(Math.random()*72)+1;
        const t1=TAGS[Math.floor(Math.random()*TAGS.length)];
        const t2=Math.random()>0.6?TAGS[Math.floor(Math.random()*TAGS.length)]:'';
        trades.push({
            id:Date.now()+i,date:d.toISOString().slice(0,16),instrument:inst,direction:dir,
            entry:+ep.toFixed(inst.includes('USD')&&!inst.includes('BTC')?5:2),
            exit:+xp.toFixed(inst.includes('USD')&&!inst.includes('BTC')?5:2),
            size:+sz.toFixed(2),pnl:finalPnl,pnlPct:+(finalPnl/(ep*sz||1)*100).toFixed(2),
            duration:durH+'h',tags:[t1,t2].filter(Boolean),notes:'',
            emotion:EMOTIONS[Math.floor(Math.random()*5)],rating:Math.floor(Math.random()*3)+3
        });
    }
    return trades.sort((a,b)=>new Date(b.date)-new Date(a.date));
}
function getTrades(){let t=localStorage.getItem('tj-trades');if(!t){const s=seedTrades();localStorage.setItem('tj-trades',JSON.stringify(s));return s;}return JSON.parse(t);}
function saveTrades(t){localStorage.setItem('tj-trades',JSON.stringify(t));}
let trades=getTrades();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pnlColor(v){return v>=0?'var(--grn)':'var(--red)';}
function fmt$(v){return(v>=0?'+':'')+v.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0});}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TABS=['Dashboard','Trade Log','Portfolio','Calendar','Analytics'];
let curTab=0;
function initNav(){
    document.getElementById('nav').innerHTML=TABS.map((t,i)=>`<button class="seg-btn${i===0?' on':''}" onclick="switchTab(${i})">${t}</button>`).join('');
}
function switchTab(i){
    curTab=i;
    document.querySelectorAll('.seg-btn').forEach((b,j)=>b.classList.toggle('on',j===i));
    render();
}
function render(){
    const p=document.getElementById('panels');
    const fns=[renderDashboard,renderTradeLog,renderPortfolio,renderCalendar,renderAnalytics];
    p.innerHTML='<div class="pnl on" id="pnl"></div>';
    fns[curTab]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD TRADE SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let addDir='LONG',addTags=new Set(),addEmo='',addRating=0,addInst='';
function openSheet(){
    addDir='LONG';addTags.clear();addEmo='';addRating=0;addInst='';
    document.getElementById('sheetBg').classList.add('show');
    renderForm();
}
function closeSheet(){document.getElementById('sheetBg').classList.remove('show');}
function renderForm(){
    const f=document.getElementById('sheetForm');
    f.innerHTML=`
    <!-- Instrument Search -->
    <div class="fg" style="position:relative">
        <label>Instrument</label>
        <input type="text" id="f-inst" placeholder="Search ticker... AAPL, XAUUSD, BTCUSD" value="${addInst}" oninput="filterInst(this.value)" onfocus="document.getElementById('inst-dd').style.display='block'" autocomplete="off"/>
        <div id="inst-dd" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:180px;overflow-y:auto;background:#1a1a1a;border:1px solid var(--brd2);border-radius:12px;z-index:50;margin-top:4px"></div>
    </div>
    <!-- Direction -->
    <div class="dir-btns">
        <button class="dir-btn long ${addDir==='LONG'?'sel':''}" onclick="addDir='LONG';renderForm()">‚ñ≤ LONG</button>
        <button class="dir-btn short ${addDir==='SHORT'?'sel':''}" onclick="addDir='SHORT';renderForm()">‚ñº SHORT</button>
    </div>
    <!-- Live P&L -->
    <div class="live-pnl">
        <div class="lp-item"><div class="lp-val" id="lp-pnl" style="color:var(--dim)">$0</div><div class="lp-lbl">P&L</div></div>
        <div class="lp-item"><div class="lp-val" id="lp-pct" style="color:var(--dim)">0%</div><div class="lp-lbl">Return</div></div>
        <div class="lp-item"><div class="lp-val" id="lp-dur" style="color:var(--dim)">‚Äî</div><div class="lp-lbl">Duration</div></div>
    </div>
    <!-- Prices -->
    <div class="fg-row3">
        <div class="fg"><label>Entry</label><input type="number" step="any" id="f-ep" placeholder="0.00" oninput="calcLive()"/></div>
        <div class="fg"><label>Exit</label><input type="number" step="any" id="f-xp" placeholder="0.00" oninput="calcLive()"/></div>
        <div class="fg"><label>Size</label><input type="number" step="any" id="f-sz" placeholder="1.0" value="1" oninput="calcLive()"/></div>
    </div>
    <!-- Dates -->
    <div class="fg-row">
        <div class="fg"><label>Entry Date</label><input type="datetime-local" id="f-ed" value="${new Date().toISOString().slice(0,16)}" oninput="calcLive()"/></div>
        <div class="fg"><label>Exit Date</label><input type="datetime-local" id="f-xd" value="${new Date().toISOString().slice(0,16)}" oninput="calcLive()"/></div>
    </div>
    <!-- Tags -->
    <div class="fg"><label>Tags</label><div class="tags-row">${TAGS.map(t=>`<button class="tag-btn ${addTags.has(t)?'sel':''}" onclick="addTags.has('${t}')?addTags.delete('${t}'):addTags.add('${t}');renderForm()">${t}</button>`).join('')}</div></div>
    <!-- Emotion & Rating -->
    <div style="display:flex;gap:24px;margin-bottom:16px">
        <div class="fg" style="margin:0"><label>Emotion</label><div class="emo-row">${EMOTIONS.map(e=>`<button class="emo-btn ${addEmo===e?'sel':''}" onclick="addEmo='${e}';renderForm()">${e}</button>`).join('')}</div></div>
        <div class="fg" style="margin:0"><label>Rating</label><div class="stars">${[1,2,3,4,5].map(i=>`<button class="star ${i<=addRating?'lit':''}" onclick="addRating=${i};renderForm()">‚òÖ</button>`).join('')}</div></div>
    </div>
    <!-- Notes -->
    <div class="fg"><label>Notes</label><textarea id="f-notes" placeholder="What was your thesis?"></textarea></div>
    <button class="save-btn" onclick="saveTrade()">Save Trade</button>`;
    document.addEventListener('click',e=>{if(!e.target.closest('#f-inst')&&!e.target.closest('#inst-dd')){const d=document.getElementById('inst-dd');if(d)d.style.display='none';}},{once:true});
}
function filterInst(q){
    const dd=document.getElementById('inst-dd');if(!dd)return;
    const list=INSTRUMENTS.filter(i=>i.toLowerCase().includes(q.toLowerCase())).slice(0,12);
    dd.innerHTML=list.map(i=>`<div style="padding:10px 16px;cursor:pointer;font-size:14px;font-weight:500;border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)'" onmouseleave="this.style.background=''" onclick="addInst='${i}';document.getElementById('f-inst').value='${i}';document.getElementById('inst-dd').style.display='none'">${i} <span style="color:var(--mut);font-size:11px;margin-left:6px">${getClass(i)}</span></div>`).join('');
    dd.style.display=list.length?'block':'none';
}
function calcLive(){
    const ep=+document.getElementById('f-ep')?.value||0;
    const xp=+document.getElementById('f-xp')?.value||0;
    const sz=+document.getElementById('f-sz')?.value||1;
    const ed=document.getElementById('f-ed')?.value;
    const xd=document.getElementById('f-xd')?.value;
    if(!ep)return;
    const diff=addDir==='LONG'?xp-ep:ep-xp;
    const pnl=Math.round(diff*sz*100);
    const pct=ep?(diff/ep*100).toFixed(2):0;
    const el=id=>document.getElementById(id);
    if(el('lp-pnl')){el('lp-pnl').textContent=fmt$(pnl);el('lp-pnl').style.color=pnlColor(pnl);}
    if(el('lp-pct')){el('lp-pct').textContent=(pct>=0?'+':'')+pct+'%';el('lp-pct').style.color=pnlColor(pnl);}
    if(ed&&xd){const h=Math.round((new Date(xd)-new Date(ed))/3600000);el('lp-dur').textContent=h>0?h+'h':'‚Äî';}
}
function saveTrade(){
    const inst=addInst||document.getElementById('f-inst')?.value||'';
    if(!inst){toast('‚ö†Ô∏è Select an instrument');return;}
    const ep=+document.getElementById('f-ep').value;
    const xp=+document.getElementById('f-xp').value;
    const sz=+document.getElementById('f-sz').value||1;
    if(!ep){toast('‚ö†Ô∏è Enter entry price');return;}
    const diff=addDir==='LONG'?(xp||ep)-ep:ep-(xp||ep);
    const pnl=Math.round(diff*sz*100);
    const ed=document.getElementById('f-ed').value;
    const xd=document.getElementById('f-xd').value;
    const durH=Math.max(0,Math.round((new Date(xd)-new Date(ed))/3600000));
    const t={
        id:Date.now(),date:ed,instrument:inst,direction:addDir,entry:ep,exit:xp||null,size:sz,
        pnl,pnlPct:+(diff/(ep||1)*100).toFixed(2),duration:durH+'h',
        tags:[...addTags],notes:document.getElementById('f-notes')?.value||'',
        emotion:addEmo,rating:addRating
    };
    trades.unshift(t);saveTrades(trades);
    closeSheet();
    toast('‚úÖ Trade saved');
    switchTab(2); // Go to Portfolio
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
    const t=trades;
    const totalPnl=t.reduce((s,x)=>s+x.pnl,0);
    const wins=t.filter(x=>x.pnl>0).length;
    const losses=t.filter(x=>x.pnl<=0).length;
    const winRate=t.length?(wins/t.length*100).toFixed(1):0;
    const avgWin=wins?t.filter(x=>x.pnl>0).reduce((s,x)=>s+x.pnl,0)/wins:0;
    const avgLoss=losses?Math.abs(t.filter(x=>x.pnl<=0).reduce((s,x)=>s+x.pnl,0)/losses):1;
    const pf=(avgWin/avgLoss).toFixed(2);
    const best=t.length?Math.max(...t.map(x=>x.pnl)):0;

    let h=`<div class="stats">
        <div class="card stat"><div class="lbl">Total P&L</div><div class="val" style="color:${pnlColor(totalPnl)}">${fmt$(totalPnl)}</div><div class="lbl">${t.length} trades</div></div>
        <div class="card stat"><div class="lbl">Win Rate</div><div class="val" style="color:var(--cyn)">${winRate}%</div><div class="lbl">${wins}W / ${losses}L</div></div>
        <div class="card stat"><div class="lbl">Total Trades</div><div class="val">${t.length}</div><div class="lbl">this period</div></div>
        <div class="card stat"><div class="lbl">Profit Factor</div><div class="val" style="color:var(--gld)">${pf}</div><div class="lbl">avg win / avg loss</div></div>
        <div class="card stat"><div class="lbl">Best Trade</div><div class="val" style="color:var(--grn)">${fmt$(best)}</div><div class="lbl">single trade</div></div>
    </div>`;
    // Equity curve + Recent trades
    h+=`<div class="row2">
        <div class="card"><div class="card-title">Equity Curve</div><canvas id="eqCanvas" height="260"></canvas></div>
        <div class="card"><div class="card-title">Recent Trades</div><div id="recentList"></div></div>
    </div>`;
    // Treemap
    h+=`<div class="card"><div class="card-title">Portfolio Treemap</div><div class="treemap-wrap"><canvas id="tmCanvas" height="280"></canvas></div></div>`;

    document.getElementById('pnl').innerHTML=h;
    drawEquity();drawTreemap();
    const recent=t.slice(0,10);
    document.getElementById('recentList').innerHTML=recent.map(r=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px">
            <div><span style="font-weight:600">${r.instrument}</span> <span class="${r.direction==='LONG'?'dir-long':'dir-short'}" style="font-size:11px">${r.direction}</span></div>
            <div style="color:${pnlColor(r.pnl)};font-weight:600;font-family:'JetBrains Mono'">${fmt$(r.pnl)}</div>
        </div>`).join('');
}

function drawEquity(){
    const c=document.getElementById('eqCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const sorted=[...trades].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let cum=0;const pts=sorted.map(t=>{cum+=t.pnl;return cum;});
    if(!pts.length)return;
    const W=c.width,H=c.height,pad=40;
    const maxV=Math.max(...pts,0),minV=Math.min(...pts,0),range=maxV-minV||1;
    ctx.clearRect(0,0,W,H);
    // Grid
    ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
    for(let i=0;i<5;i++){const y=pad+i*(H-2*pad)/4;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W,y);ctx.stroke();}
    // Line
    ctx.beginPath();
    pts.forEach((v,i)=>{const x=pad+i*(W-pad)/(pts.length-1||1);const y=H-pad-(v-minV)/range*(H-2*pad);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.strokeStyle='#34d399';ctx.lineWidth=2.5;ctx.stroke();
    // Fill
    const lastX=pad+(pts.length-1)*(W-pad)/(pts.length-1||1);
    ctx.lineTo(lastX,H-pad);ctx.lineTo(pad,H-pad);ctx.closePath();
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'rgba(52,211,153,0.12)');grd.addColorStop(1,'rgba(52,211,153,0)');
    ctx.fillStyle=grd;ctx.fill();
    // Labels
    ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px JetBrains Mono';ctx.textAlign='right';
    for(let i=0;i<5;i++){const v=maxV-i*range/4;ctx.fillText('$'+Math.round(v),pad-6,pad+i*(H-2*pad)/4+4);}
}

function drawTreemap(){
    const c=document.getElementById('tmCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const byInst={};
    trades.forEach(t=>{if(!byInst[t.instrument])byInst[t.instrument]={pnl:0,size:0};byInst[t.instrument].pnl+=t.pnl;byInst[t.instrument].size+=t.size;});
    const items=Object.entries(byInst).map(([k,v])=>({name:k,pnl:v.pnl,size:Math.abs(v.size),cls:getClass(k)})).sort((a,b)=>b.size-a.size);
    if(!items.length)return;
    const W=c.width,H=c.height;
    const totalSize=items.reduce((s,i)=>s+i.size,0)||1;
    // Simple squarified treemap (row-based)
    let rects=[];let x=0,y=0,rw=W,rh=H;
    let remaining=[...items];
    while(remaining.length){
        const isWide=rw>=rh;
        const dim=isWide?rh:rw;
        let row=[],rowSize=0;
        const totalRemaining=remaining.reduce((s,i)=>s+i.size,0);
        for(let i=0;i<remaining.length;i++){
            row.push(remaining[i]);rowSize+=remaining[i].size;
            if(row.length>=Math.ceil(remaining.length/2)||row.length>=4)break;
        }
        remaining=remaining.slice(row.length);
        const rowFrac=rowSize/totalRemaining;
        const rowDim=isWide?rw*rowFrac:rh*rowFrac;
        let pos=0;
        row.forEach(item=>{
            const frac=item.size/rowSize;
            const iw=isWide?rowDim:dim*frac;
            const ih=isWide?dim*frac:rowDim;
            const ix=isWide?x:x+pos;
            const iy=isWide?y+pos:y;
            rects.push({...item,x:ix,y:iy,w:iw,h:ih});
            pos+=isWide?ih:iw;
        });
        if(isWide){x+=rowDim;rw-=rowDim;}else{y+=rowDim;rh-=rowDim;}
    }
    // Draw
    const maxPnl=Math.max(...rects.map(r=>Math.abs(r.pnl)),1);
    rects.forEach(r=>{
        const intensity=Math.min(Math.abs(r.pnl)/maxPnl,1)*0.6+0.15;
        ctx.fillStyle=r.pnl>=0?`rgba(52,211,153,${intensity})`:`rgba(248,113,113,${intensity})`;
        ctx.beginPath();
        const m=1.5;
        ctx.roundRect(r.x+m,r.y+m,Math.max(r.w-m*2,0),Math.max(r.h-m*2,0),6);
        ctx.fill();
        // Label
        if(r.w>40&&r.h>30){
            ctx.fillStyle='rgba(255,255,255,0.85)';
            const fs=Math.min(Math.max(r.w/6,10),14);
            ctx.font=`600 ${fs}px Inter`;ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText(r.name,r.x+r.w/2,r.y+r.h/2-6);
            ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font=`500 ${Math.max(fs-2,9)}px JetBrains Mono`;
            ctx.fillText(fmt$(r.pnl),r.x+r.w/2,r.y+r.h/2+8);
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADE LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let logSort={col:'date',asc:false},logFilter={search:'',inst:'',dir:''};
function renderTradeLog(){
    let filtered=[...trades];
    if(logFilter.search){const q=logFilter.search.toLowerCase();filtered=filtered.filter(t=>`${t.instrument} ${t.tags.join(' ')} ${t.notes}`.toLowerCase().includes(q));}
    if(logFilter.inst)filtered=filtered.filter(t=>t.instrument===logFilter.inst);
    if(logFilter.dir)filtered=filtered.filter(t=>t.direction===logFilter.dir);
    filtered.sort((a,b)=>{let v=0;if(logSort.col==='date')v=new Date(a.date)-new Date(b.date);else if(logSort.col==='pnl')v=a.pnl-b.pnl;else if(logSort.col==='instrument')v=a.instrument.localeCompare(b.instrument);return logSort.asc?v:-v;});
    const insts=[...new Set(trades.map(t=>t.instrument))].sort();
    let h=`<div class="card"><div class="card-title">Trade Log</div>
    <div class="filters">
        <input class="flt" placeholder="üîç Search trades..." value="${logFilter.search}" oninput="logFilter.search=this.value;renderTradeLog()"/>
        <select class="flt" onchange="logFilter.inst=this.value;renderTradeLog()"><option value="">All Instruments</option>${insts.map(i=>`<option ${logFilter.inst===i?'selected':''}>${i}</option>`).join('')}</select>
        <select class="flt" onchange="logFilter.dir=this.value;renderTradeLog()"><option value="">All Directions</option><option ${logFilter.dir==='LONG'?'selected':''}>LONG</option><option ${logFilter.dir==='SHORT'?'selected':''}>SHORT</option></select>
        <span style="font-size:12px;color:var(--dim);align-self:center;margin-left:auto">${filtered.length} trades</span>
    </div>
    <div class="tbl-wrap"><table>
    <tr><th onclick="sortLog('date')">Date ${logSort.col==='date'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th onclick="sortLog('instrument')">Instrument ${logSort.col==='instrument'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Size</th><th onclick="sortLog('pnl')">P&L ${logSort.col==='pnl'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th>Duration</th><th>Tags</th><th>Rating</th></tr>
    ${filtered.map(t=>`<tr>
        <td style="font-family:'JetBrains Mono';font-size:12px">${new Date(t.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
        <td style="font-weight:600">${t.instrument}</td>
        <td class="${t.direction==='LONG'?'dir-long':'dir-short'}">${t.direction}</td>
        <td style="font-family:'JetBrains Mono'">${t.entry}</td>
        <td style="font-family:'JetBrains Mono'">${t.exit||'‚Äî'}</td>
        <td>${t.size}</td>
        <td style="color:${pnlColor(t.pnl)};font-weight:600;font-family:'JetBrains Mono'">${fmt$(t.pnl)}</td>
        <td>${t.duration}</td>
        <td>${t.tags.map(g=>`<span class="pill pill-tag">${g}</span>`).join('')}</td>
        <td>${'‚òÖ'.repeat(t.rating)+'‚òÜ'.repeat(5-t.rating)}</td>
    </tr>`).join('')}
    </table></div></div>`;
    document.getElementById('pnl').innerHTML=h;
}
function sortLog(col){if(logSort.col===col)logSort.asc=!logSort.asc;else{logSort.col=col;logSort.asc=false;}renderTradeLog();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PORTFOLIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPortfolio(){
    const totalPnl=trades.reduce((s,t)=>s+t.pnl,0);
    const wins=trades.filter(t=>t.pnl>0).length;
    const best=trades.length?Math.max(...trades.map(t=>t.pnl)):0;
    const worst=trades.length?Math.min(...trades.map(t=>t.pnl)):0;

    // Group trades by asset class
    const groups={};
    trades.forEach(t=>{
        const cls=getClass(t.instrument);
        if(!groups[cls])groups[cls]=[];
        groups[cls].push(t);
    });

    let h=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
        <div class="card stat"><div class="lbl">Total P&L</div><div class="val" style="color:${pnlColor(totalPnl)}">${fmt$(totalPnl)}</div></div>
        <div class="card stat"><div class="lbl">Positions</div><div class="val" style="color:var(--cyn)">${trades.length}</div></div>
        <div class="card stat"><div class="lbl">Win Rate</div><div class="val" style="color:var(--gld)">${trades.length?(wins/trades.length*100).toFixed(1):0}%</div></div>
        <div class="card stat"><div class="lbl">Best / Worst</div><div class="val" style="font-size:0.9rem"><span style="color:var(--grn)">${fmt$(best)}</span> <span style="color:var(--mut)">/</span> <span style="color:var(--red)">${fmt$(worst)}</span></div></div>
    </div>`;

    Object.entries(groups).sort((a,b)=>b[1].reduce((s,t)=>s+t.pnl,0)-a[1].reduce((s,t)=>s+t.pnl,0)).forEach(([cls,items])=>{
        const clsPnl=items.reduce((s,t)=>s+t.pnl,0);
        h+=`<div style="margin-bottom:20px">
            <div class="ac-badge" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'grid':'none';this.querySelector('.ac-arrow').classList.toggle('collapsed')">
                <span class="ac-dot" style="background:${AC_COLORS[cls]||'#888'}"></span>
                ${cls} <span style="color:var(--mut);font-weight:400">${items.length} trades</span>
                <span style="color:${pnlColor(clsPnl)};font-family:'JetBrains Mono';font-size:12px;margin-left:8px">${fmt$(clsPnl)}</span>
                <span class="ac-arrow">‚ñº</span>
            </div>
            <div class="pos-grid">`;
        items.forEach(t=>{
            h+=`<div class="card pos-card">
                <div class="pos-header">
                    <span class="pos-inst">${t.instrument}</span>
                    <span class="pos-dir ${t.direction.toLowerCase()}">${t.direction}</span>
                </div>
                <div class="pos-details">
                    <div class="pos-detail"><span class="pd-lbl">Entry</span><span class="pd-val">${t.entry}</span></div>
                    <div class="pos-detail"><span class="pd-lbl">Exit</span><span class="pd-val">${t.exit||'Open'}</span></div>
                    <div class="pos-detail"><span class="pd-lbl">Size</span><span class="pd-val">${t.size}</span></div>
                    <div class="pos-detail"><span class="pd-lbl">P&L</span><span class="pd-val" style="color:${pnlColor(t.pnl)}">${fmt$(t.pnl)}</span></div>
                </div>
                ${t.tags.length?`<div class="pos-tags">${t.tags.map(g=>`<span class="pill pill-tag">${g}</span>`).join('')}</div>`:''}
            </div>`;
        });
        h+=`</div></div>`;
    });
    document.getElementById('pnl').innerHTML=h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calMonth=1,calYear=2026;
function renderCalendar(){
    const dailyPnl={};
    trades.forEach(t=>{const d=new Date(t.date);const k=d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();if(!dailyPnl[k])dailyPnl[k]={pnl:0,cnt:0};dailyPnl[k].pnl+=t.pnl;dailyPnl[k].cnt++;});
    const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
    const first=new Date(calYear,calMonth,1);
    const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
    const startDay=first.getDay();
    const today=new Date();

    let h=`<div class="card">
    <div class="cal-nav">
        <button onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar()">‚Üê Prev</button>
        <div class="month">${months[calMonth]} ${calYear}</div>
        <button onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar()">Next ‚Üí</button>
    </div>
    <div class="cal-grid">
        ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="cal-hdr">${d}</div>`).join('')}`;
    for(let i=0;i<startDay;i++)h+=`<div class="cal-day empty"></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const key=calYear+'-'+(calMonth+1)+'-'+d;
        const data=dailyPnl[key];
        const isToday=today.getDate()===d&&today.getMonth()===calMonth&&today.getFullYear()===calYear;
        let bg='transparent';
        if(data){const int=Math.min(Math.abs(data.pnl)/1500,1);bg=data.pnl>=0?`rgba(52,211,153,${0.05+int*0.2})`:`rgba(248,113,113,${0.05+int*0.2})`;}
        h+=`<div class="cal-day${isToday?' today':''}" style="background:${bg}">
            <div class="d-num">${d}</div>
            ${data?`<div class="d-pnl" style="color:${pnlColor(data.pnl)}">${fmt$(data.pnl)}</div><div class="d-cnt">${data.cnt} trade${data.cnt>1?'s':''}</div>`:''}
        </div>`;
    }
    h+=`</div></div>`;
    document.getElementById('pnl').innerHTML=h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAnalytics(){
    const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<=0);
    let curWin=0,maxWin=0,curLoss=0,maxLoss=0;
    [...trades].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t=>{
        if(t.pnl>0){curWin++;curLoss=0;maxWin=Math.max(maxWin,curWin);}
        else{curLoss++;curWin=0;maxLoss=Math.max(maxLoss,curLoss);}
    });
    let h=`<div class="streak-row">
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${curWin}</div><div class="s-lbl">Current Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${maxWin}</div><div class="s-lbl">Max Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${curLoss}</div><div class="s-lbl">Current Loss Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${maxLoss}</div><div class="s-lbl">Max Loss Streak</div></div>
    </div>`;
    h+=`<div class="ana-grid">
        <div class="card"><div class="card-title">Win / Loss</div><canvas id="wlCanvas" height="220"></canvas></div>
        <div class="card"><div class="card-title">P&L Distribution</div><canvas id="pnlDistCanvas" height="220"></canvas></div>
    </div>`;
    h+=`<div class="card" style="margin-bottom:14px"><div class="card-title">Bubble Chart ‚Äî Instruments</div><canvas id="bubbleCanvas" height="320"></canvas></div>`;
    h+=`<div class="ana-grid">
        <div class="card"><div class="card-title">Performance by Day</div><canvas id="dayCanvas" height="200"></canvas></div>
        <div class="card"><div class="card-title">Performance by Session</div><canvas id="sessCanvas" height="200"></canvas></div>
    </div>`;
    document.getElementById('pnl').innerHTML=h;
    setTimeout(()=>{drawDonut(wins.length,losses.length);drawPnlDist();drawBubble();drawByDay();drawBySession();},60);
}

function drawDonut(w,l){
    const c=document.getElementById('wlCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const cx=c.width/2,cy=c.height/2+10,r=70,total=w+l||1;
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+w/total*Math.PI*2);ctx.lineWidth=22;ctx.strokeStyle='#34d399';ctx.stroke();
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2+w/total*Math.PI*2,-Math.PI/2+Math.PI*2);ctx.lineWidth=22;ctx.strokeStyle='#f87171';ctx.stroke();
    ctx.fillStyle='#f5f5f7';ctx.font='bold 22px JetBrains Mono';ctx.textAlign='center';ctx.fillText((w/total*100).toFixed(0)+'%',cx,cy+2);
    ctx.fillStyle='rgba(255,255,255,0.35)';ctx.font='12px Inter';ctx.fillText('Win Rate',cx,cy+22);
}

function drawPnlDist(){
    const c=document.getElementById('pnlDistCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const buckets=[{l:'<-500',min:-Infinity,max:-500},{l:'-500 to -200',min:-500,max:-200},{l:'-200 to 0',min:-200,max:0},{l:'0 to 200',min:0,max:200},{l:'200 to 500',min:200,max:500},{l:'>500',min:500,max:Infinity}];
    const counts=buckets.map(b=>trades.filter(t=>t.pnl>=b.min&&t.pnl<b.max).length);
    const maxC=Math.max(...counts,1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/buckets.length-8;
    buckets.forEach((b,i)=>{
        const x=pad+i*(barW+8);const h=counts[i]/maxC*(H-pad-30);
        ctx.fillStyle=b.max<=0?'rgba(248,113,113,0.5)':'rgba(52,211,153,0.5)';
        ctx.beginPath();ctx.roundRect(x,H-pad-h,barW,h,4);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='9px Inter';ctx.textAlign='center';
        ctx.fillText(b.l,x+barW/2,H-pad+14);
        if(counts[i]){ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fillText(counts[i],x+barW/2,H-pad-h-6);}
    });
}

function drawBubble(){
    const c=document.getElementById('bubbleCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const W=c.width,H=c.height,pad=60;
    // Group by instrument
    const byInst={};
    trades.forEach(t=>{
        if(!byInst[t.instrument])byInst[t.instrument]={wins:0,total:0,pnl:0,cls:getClass(t.instrument)};
        byInst[t.instrument].total++;byInst[t.instrument].pnl+=t.pnl;
        if(t.pnl>0)byInst[t.instrument].wins++;
    });
    const items=Object.entries(byInst).map(([k,v])=>({name:k,winRate:v.total?v.wins/v.total*100:0,avgPnl:v.pnl/v.total,trades:v.total,cls:v.cls}));
    if(!items.length)return;
    const maxTrades=Math.max(...items.map(i=>i.trades));
    const maxPnl=Math.max(...items.map(i=>Math.abs(i.avgPnl)),1);
    // Axes
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,H-pad);ctx.lineTo(W-20,H-pad);ctx.stroke();
    // Labels
    ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px Inter';ctx.textAlign='center';
    ctx.fillText('Win Rate %',W/2,H-10);
    ctx.save();ctx.translate(14,H/2);ctx.rotate(-Math.PI/2);ctx.fillText('Avg P&L ($)',0,0);ctx.restore();
    // Axis ticks
    for(let i=0;i<=4;i++){
        const wr=i*25;const x=pad+(wr/100)*(W-pad-20);
        ctx.fillStyle='rgba(255,255,255,0.2)';ctx.font='9px JetBrains Mono';ctx.textAlign='center';
        ctx.fillText(wr+'%',x,H-pad+16);
    }
    const midY=(pad+H-pad)/2;
    ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W-20,midY);ctx.stroke();
    // Bubbles
    items.forEach(item=>{
        const x=pad+(item.winRate/100)*(W-pad-20);
        const y=midY-(item.avgPnl/maxPnl)*((H-2*pad)/2)*0.8;
        const r=Math.max(6,Math.min(item.trades/maxTrades*30,30));
        const color=AC_COLORS[item.cls]||'#888';
        ctx.globalAlpha=0.35;ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=0.8;ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
        ctx.globalAlpha=1;
        if(r>10){ctx.fillStyle='rgba(255,255,255,0.8)';ctx.font=`${Math.max(8,Math.min(r/2,11))}px Inter`;ctx.textAlign='center';ctx.fillText(item.name,x,y+3);}
    });
    // Legend
    let lx=pad;
    Object.entries(AC_COLORS).forEach(([cls,col])=>{
        ctx.fillStyle=col;ctx.beginPath();ctx.arc(lx+5,20,4,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='10px Inter';ctx.textAlign='left';ctx.fillText(cls,lx+13,24);
        lx+=ctx.measureText(cls).width+28;
    });
}

function drawByDay(){
    const c=document.getElementById('dayCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const byDay=Array(7).fill(null).map(()=>({sum:0,cnt:0}));
    trades.forEach(t=>{const d=new Date(t.date).getDay();byDay[d].sum+=t.pnl;byDay[d].cnt++;});
    const avgs=byDay.map(d=>d.cnt?d.sum/d.cnt:0);
    const maxA=Math.max(...avgs.map(Math.abs),1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/7-10,midY=H/2;
    ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W,midY);ctx.stroke();
    avgs.forEach((v,i)=>{
        const x=pad+i*(barW+10);const h=Math.abs(v)/maxA*(H/2-30);
        ctx.fillStyle=v>=0?'rgba(52,211,153,0.5)':'rgba(248,113,113,0.5)';
        ctx.beginPath();ctx.roundRect(x,v>=0?midY-h:midY,barW,h,4);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px Inter';ctx.textAlign='center';
        ctx.fillText(days[i],x+barW/2,H-8);
        if(v){ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='9px JetBrains Mono';ctx.fillText(fmt$(Math.round(v)),x+barW/2,v>=0?midY-h-6:midY+h+14);}
    });
}

function drawBySession(){
    const c=document.getElementById('sessCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-40;
    const sessions=[{n:'Asian',h:[0,8]},{n:'London',h:[8,16]},{n:'New York',h:[13,21]}];
    const data=sessions.map(s=>{const t=trades.filter(tr=>{const h=new Date(tr.date).getHours();return h>=s.h[0]&&h<s.h[1];});return{name:s.n,pnl:t.reduce((a,x)=>a+x.pnl,0),cnt:t.length};});
    const maxP=Math.max(...data.map(d=>Math.abs(d.pnl)),1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/3-20,midY=H/2;
    ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W,midY);ctx.stroke();
    data.forEach((d,i)=>{
        const x=pad+i*(barW+20);const h=Math.abs(d.pnl)/maxP*(H/2-30);
        ctx.fillStyle=d.pnl>=0?'rgba(52,211,153,0.5)':'rgba(248,113,113,0.5)';
        ctx.beginPath();ctx.roundRect(x,d.pnl>=0?midY-h:midY,barW,h,4);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.35)';ctx.font='11px Inter';ctx.textAlign='center';
        ctx.fillText(d.name,x+barW/2,H-8);
        ctx.fillStyle=d.pnl>=0?'rgba(52,211,153,0.7)':'rgba(248,113,113,0.7)';ctx.font='10px JetBrains Mono';
        ctx.fillText(fmt$(d.pnl),x+barW/2,d.pnl>=0?midY-h-8:midY+h+16);
        ctx.fillStyle='rgba(255,255,255,0.2)';ctx.font='9px Inter';ctx.fillText(d.cnt+' trades',x+barW/2,H-20);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initNav();
render();
document.addEventListener('keydown',e=>{if(e.key>='1'&&e.key<='5'&&!document.querySelector('.sheet-bg.show'))switchTab(+e.key-1);if(e.key==='n'||e.key==='N')openSheet();if(e.key==='Escape')closeSheet();});
</script>
</body>
</html>
