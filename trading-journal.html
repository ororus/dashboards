<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tradyom Trading Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#06060b;--s1:rgba(255,255,255,0.035);--s2:rgba(255,255,255,0.06);--brd:rgba(255,255,255,0.08);--txt:#e8e8ed;--dim:rgba(255,255,255,0.5);--mut:rgba(255,255,255,0.25);--grn:#10b981;--red:#ef4444;--cyn:#22d3ee;--gld:#f59e0b;--pur:#a855f7;--blu:#3b82f6;--org:#f97316;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(16,185,129,0.04),transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(34,211,238,0.03),transparent 50%);pointer-events:none;}
.app{max-width:1400px;margin:0 auto;padding:16px 20px;position:relative;z-index:1;}

/* NAV */
.nav{display:flex;align-items:center;gap:20px;padding:10px 0 16px;border-bottom:1px solid var(--brd);margin-bottom:20px;}
.nav-logo{font-family:'Orbitron';font-size:18px;letter-spacing:2px;background:linear-gradient(135deg,var(--grn),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;}
.nav-tabs{display:flex;gap:4px;margin-left:auto;background:var(--s1);border-radius:8px;padding:3px;}
.nt{padding:7px 16px;border:none;background:transparent;color:var(--dim);font-size:12px;font-family:inherit;font-weight:500;cursor:pointer;border-radius:6px;transition:all .15s;white-space:nowrap;}
.nt:hover{color:var(--txt);} .nt.on{background:var(--grn);color:#000;font-weight:600;}

/* PANELS */
.pnl{display:none;}.pnl.on{display:block;}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--brd);border-radius:10px;padding:16px;}
.card-title{font-family:'Orbitron';font-size:10px;letter-spacing:1.5px;color:var(--cyn);margin-bottom:12px;}

/* STATS ROW */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px;}
.stat{text-align:center;padding:14px 10px;}
.stat .val{font-size:22px;font-weight:700;font-family:'JetBrains Mono';margin:4px 0 2px;}
.stat .lbl{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;}

/* 2-COL */
.row2{display:grid;grid-template-columns:1.5fr 1fr;gap:12px;margin-bottom:16px;}

/* TRADE LOG TABLE */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{font-family:'Orbitron';font-size:9px;letter-spacing:1px;color:var(--mut);text-transform:uppercase;padding:8px 10px;text-align:left;border-bottom:1px solid var(--brd);cursor:pointer;white-space:nowrap;user-select:none;}
th:hover{color:var(--cyn);}
td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03);white-space:nowrap;}
tr:hover td{background:rgba(255,255,255,0.02);}
.pill-tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:9px;background:rgba(168,85,247,0.12);color:var(--pur);margin-right:3px;}
.dir-long{color:var(--grn);font-weight:600;} .dir-short{color:var(--red);font-weight:600;}

/* FILTERS */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.flt{padding:6px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--brd);border-radius:6px;color:var(--dim);font-size:11px;font-family:inherit;outline:none;}
.flt:focus{border-color:var(--grn);}
select.flt{cursor:pointer;}

/* ADD TRADE FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-group{display:flex;flex-direction:column;gap:4px;}
.form-group label{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;}
.form-group input,.form-group select,.form-group textarea{padding:8px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--brd);border-radius:6px;color:var(--txt);font-size:13px;font-family:inherit;outline:none;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--grn);}
.form-group textarea{resize:vertical;min-height:60px;}
.dir-toggle{display:flex;gap:8px;}
.dir-btn{flex:1;padding:10px;border:2px solid var(--brd);border-radius:8px;background:transparent;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;}
.dir-btn.long{color:var(--grn);} .dir-btn.short{color:var(--red);}
.dir-btn.long.sel{background:rgba(16,185,129,0.15);border-color:var(--grn);}
.dir-btn.short.sel{background:rgba(239,68,68,0.15);border-color:var(--red);}
.tags-row{display:flex;flex-wrap:wrap;gap:6px;}
.tag-btn{padding:4px 12px;border-radius:14px;border:1px solid var(--brd);background:transparent;color:var(--dim);font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s;}
.tag-btn.sel{background:rgba(168,85,247,0.15);border-color:var(--pur);color:var(--pur);}
.emotions{display:flex;gap:8px;}
.emo-btn{font-size:22px;cursor:pointer;padding:4px;border:2px solid transparent;border-radius:8px;background:none;transition:all .15s;}
.emo-btn.sel{border-color:var(--gld);background:rgba(245,158,11,0.1);}
.stars{display:flex;gap:4px;}
.star{font-size:22px;cursor:pointer;color:var(--mut);transition:color .15s;background:none;border:none;}
.star.lit{color:var(--gld);}
.auto-calc{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--brd);}
.ac-item{text-align:center;} .ac-val{font-size:16px;font-weight:700;font-family:'JetBrains Mono';} .ac-lbl{font-size:9px;color:var(--mut);}
.save-btn{width:100%;padding:12px;background:var(--grn);color:#000;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:opacity .15s;margin-top:10px;}
.save-btn:hover{opacity:0.9;}
.mode-toggle{display:flex;gap:4px;background:var(--s1);border-radius:8px;padding:3px;margin-bottom:16px;width:fit-content;}
.mt-btn{padding:7px 18px;border:none;background:transparent;color:var(--dim);font-size:12px;font-family:inherit;font-weight:500;cursor:pointer;border-radius:6px;transition:all .15s;}
.mt-btn.on{background:var(--cyn);color:#000;font-weight:600;}

/* BROKER CARDS */
.broker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.broker-card{text-align:center;padding:20px;cursor:pointer;transition:all .2s;}
.broker-card:hover{border-color:var(--cyn);transform:translateY(-2px);}
.broker-card .b-icon{font-size:32px;margin-bottom:8px;}
.broker-card .b-name{font-family:'Orbitron';font-size:12px;color:var(--cyn);}
.broker-card .b-status{font-size:10px;color:var(--mut);margin-top:6px;}
.connect-btn{margin-top:10px;padding:6px 16px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:6px;color:var(--cyn);font-size:11px;cursor:pointer;font-family:inherit;}

/* CALENDAR */
.cal-nav{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:16px;}
.cal-nav button{background:none;border:1px solid var(--brd);color:var(--dim);padding:6px 12px;border-radius:6px;cursor:pointer;font-family:inherit;font-size:12px;}
.cal-nav button:hover{border-color:var(--cyn);color:var(--cyn);}
.cal-nav .month{font-family:'Orbitron';font-size:16px;letter-spacing:1px;min-width:180px;text-align:center;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.cal-hdr{text-align:center;font-size:10px;color:var(--mut);padding:6px;font-weight:600;}
.cal-day{min-height:70px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:6px;padding:6px;font-size:10px;cursor:default;transition:all .15s;}
.cal-day:hover{border-color:rgba(255,255,255,0.1);}
.cal-day .d-num{font-weight:600;color:var(--dim);margin-bottom:4px;}
.cal-day .d-pnl{font-size:13px;font-weight:700;font-family:'JetBrains Mono';}
.cal-day .d-cnt{font-size:9px;color:var(--mut);}
.cal-day.today{border-color:var(--cyn);}
.cal-day.empty{background:transparent;border-color:transparent;}

/* ANALYTICS */
.ana-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.streak-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;}
.streak{text-align:center;padding:12px;} .streak .s-val{font-size:20px;font-weight:700;font-family:'JetBrains Mono';} .streak .s-lbl{font-size:9px;color:var(--mut);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--grn);color:#000;padding:12px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(100px);opacity:0;transition:all .3s;}
.toast.show{transform:translateY(0);opacity:1;}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-bg.show{display:flex;}
.modal{background:#12121e;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;max-width:400px;width:90%;text-align:center;}
.modal h3{font-family:'Orbitron';margin-bottom:8px;color:var(--cyn);}
.modal p{font-size:13px;color:var(--dim);margin-bottom:16px;}
.modal button{padding:8px 20px;background:var(--cyn);color:#000;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-family:inherit;}

canvas{border-radius:8px;}
@media(max-width:900px){.stats{grid-template-columns:repeat(2,1fr);}.row2,.ana-grid{grid-template-columns:1fr;}.form-grid{grid-template-columns:1fr;}}
::-webkit-scrollbar{width:5px;height:5px;}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px;}
</style>
</head>
<body>
<div class="app">
<nav class="nav">
    <div class="nav-logo">üìà Tradyom Journal</div>
    <div class="nav-tabs">
        <button class="nt on" onclick="tab(0)">Dashboard</button>
        <button class="nt" onclick="tab(1)">Trade Log</button>
        <button class="nt" onclick="tab(2)">Add Trade</button>
        <button class="nt" onclick="tab(3)">Calendar</button>
        <button class="nt" onclick="tab(4)">Analytics</button>
    </div>
</nav>

<div class="pnl on" id="p0"></div>
<div class="pnl" id="p1"></div>
<div class="pnl" id="p2"></div>
<div class="pnl" id="p3"></div>
<div class="pnl" id="p4"></div>
</div>

<div class="toast" id="toast"></div>
<div class="modal-bg" id="modalBg" onclick="this.classList.remove('show')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>üîå Broker Connection</h3>
        <p>Broker integration is coming soon! Connect your MT4, MT5, cTrader, or IBKR account for automatic trade sync.<br><br>For now, use <strong>Manual Entry</strong> to log your trades.</p>
        <button onclick="document.getElementById('modalBg').classList.remove('show')">Got it</button>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê SAMPLE DATA ‚ïê‚ïê‚ïê
const INSTRUMENTS = ['XAUUSD','EURUSD','GBPUSD','BTCUSD','ETHUSD','AAPL','META','AMZN','TSLA','SPX500'];
const TAGS = ['breakout','trend','scalp','swing','news','reversal','support','resistance'];
const EMOTIONS = ['üòé','üò∞','üòê','üî•','üßä'];

function seedTrades(){
const trades=[];
const base=new Date(2026,1,1);
const entries={XAUUSD:2920,EURUSD:1.042,GBPUSD:1.263,BTCUSD:96500,ETHUSD:2780,AAPL:228,META:680,AMZN:218,TSLA:340,SPX500:6050};
for(let i=0;i<35;i++){
    const inst=INSTRUMENTS[Math.floor(Math.random()*INSTRUMENTS.length)];
    const dir=Math.random()>0.45?'LONG':'SHORT';
    const win=Math.random()<0.55;
    const d=new Date(base.getTime()+Math.random()*25*86400000);
    const ep=entries[inst]*(1+(Math.random()-0.5)*0.02);
    const pctMove=(Math.random()*0.03+0.002)*(win?(dir==='LONG'?1:-1):(dir==='LONG'?-1:1));
    const xp=ep*(1+pctMove);
    const size=inst.includes('USD')&&!inst.includes('BTC')&&!inst.includes('ETH')?(Math.floor(Math.random()*5)+1)*0.1:Math.floor(Math.random()*20)+1;
    const pnl=dir==='LONG'?(xp-ep)*size*(['XAUUSD','EURUSD','GBPUSD'].includes(inst)?100000:(['BTCUSD','ETHUSD'].includes(inst)?1:100)):(ep-xp)*size*(['XAUUSD','EURUSD','GBPUSD'].includes(inst)?100000:(['BTCUSD','ETHUSD'].includes(inst)?1:100));
    const finalPnl=Math.round(pnl>3000?pnl/10:pnl<-2000?pnl/5:pnl);
    const durH=Math.floor(Math.random()*72)+1;
    const tag1=TAGS[Math.floor(Math.random()*TAGS.length)];
    const tag2=Math.random()>0.6?TAGS[Math.floor(Math.random()*TAGS.length)]:'';
    trades.push({
        id:Date.now()+i, date:d.toISOString().slice(0,16), instrument:inst, direction:dir,
        entry:+ep.toFixed(inst.includes('USD')&&!inst.includes('BTC')?5:2),
        exit:+xp.toFixed(inst.includes('USD')&&!inst.includes('BTC')?5:2),
        size:+size.toFixed(2), pnl:finalPnl, pnlPct:+(finalPnl/(ep*size)*100).toFixed(2),
        duration:durH+'h', tags:[tag1,tag2].filter(Boolean), notes:'',
        emotion:EMOTIONS[Math.floor(Math.random()*5)], rating:Math.floor(Math.random()*3)+3
    });
}
return trades.sort((a,b)=>new Date(b.date)-new Date(a.date));
}

function getTrades(){
    let t=localStorage.getItem('tj-trades');
    if(!t){const s=seedTrades();localStorage.setItem('tj-trades',JSON.stringify(s));return s;}
    return JSON.parse(t);
}
function saveTrades(t){localStorage.setItem('tj-trades',JSON.stringify(t));}
let trades=getTrades();

// ‚ïê‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê‚ïê
let curTab=0;
function tab(i){
    curTab=i;
    document.querySelectorAll('.nt').forEach((b,j)=>b.classList.toggle('on',j===i));
    document.querySelectorAll('.pnl').forEach((p,j)=>p.classList.toggle('on',j===i));
    if(i===0)renderDashboard();
    if(i===1)renderTradeLog();
    if(i===2)renderAddTrade();
    if(i===3)renderCalendar();
    if(i===4)renderAnalytics();
}
document.addEventListener('keydown',e=>{if(e.key>='1'&&e.key<='5')tab(+e.key-1);});

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function pnlColor(v){return v>=0?'var(--grn)':'var(--red)';}
function fmt$(v){return(v>=0?'+':'')+v.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0});}

// ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê
function renderDashboard(){
    const t=trades;
    const totalPnl=t.reduce((s,x)=>s+x.pnl,0);
    const wins=t.filter(x=>x.pnl>0).length;
    const winRate=t.length?(wins/t.length*100).toFixed(1):0;
    const avgWin=wins?t.filter(x=>x.pnl>0).reduce((s,x)=>s+x.pnl,0)/wins:0;
    const losses=t.filter(x=>x.pnl<=0).length;
    const avgLoss=losses?Math.abs(t.filter(x=>x.pnl<=0).reduce((s,x)=>s+x.pnl,0)/losses):1;
    const pf=(avgWin/avgLoss).toFixed(2);
    const best=t.length?Math.max(...t.map(x=>x.pnl)):0;

    let h=`<div class="stats">
        <div class="card stat"><div class="lbl">Total P&L</div><div class="val" style="color:${pnlColor(totalPnl)}">${fmt$(totalPnl)}</div><div class="lbl">${t.length} trades</div></div>
        <div class="card stat"><div class="lbl">Win Rate</div><div class="val" style="color:var(--cyn)">${winRate}%</div><div class="lbl">${wins}W / ${losses}L</div></div>
        <div class="card stat"><div class="lbl">Total Trades</div><div class="val">${t.length}</div><div class="lbl">this period</div></div>
        <div class="card stat"><div class="lbl">Profit Factor</div><div class="val" style="color:var(--gld)">${pf}</div><div class="lbl">avg win / avg loss</div></div>
        <div class="card stat"><div class="lbl">Best Trade</div><div class="val" style="color:var(--grn)">${fmt$(best)}</div><div class="lbl">single trade</div></div>
    </div>`;

    h+=`<div class="row2">
        <div class="card"><div class="card-title">EQUITY CURVE</div><canvas id="eqCanvas" height="260"></canvas></div>
        <div class="card"><div class="card-title">RECENT TRADES</div><div id="recentList"></div></div>
    </div>`;
    h+=`<div class="card"><div class="card-title">P&L BY INSTRUMENT</div><canvas id="instCanvas" height="200"></canvas></div>`;

    document.getElementById('p0').innerHTML=h;
    drawEquity();drawInstruments();
    // Recent trades
    const recent=t.slice(0,10);
    document.getElementById('recentList').innerHTML=recent.map(r=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px">
            <div><span style="font-weight:600">${r.instrument}</span> <span class="${r.direction==='LONG'?'dir-long':'dir-short'}" style="font-size:10px">${r.direction}</span></div>
            <div style="color:${pnlColor(r.pnl)};font-weight:600;font-family:'JetBrains Mono'">${fmt$(r.pnl)}</div>
        </div>
    `).join('');
}

function drawEquity(){
    const c=document.getElementById('eqCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const sorted=[...trades].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let cum=0;const pts=sorted.map(t=>{cum+=t.pnl;return cum;});
    if(!pts.length)return;
    const W=c.width,H=c.height,pad=30;
    const maxV=Math.max(...pts,0),minV=Math.min(...pts,0);
    const range=maxV-minV||1;
    ctx.clearRect(0,0,W,H);
    // Grid
    ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
    for(let i=0;i<5;i++){const y=pad+i*(H-2*pad)/4;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W,y);ctx.stroke();}
    // Line
    ctx.beginPath();
    pts.forEach((v,i)=>{
        const x=pad+i*(W-pad)/(pts.length-1||1);
        const y=H-pad-(v-minV)/range*(H-2*pad);
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.strokeStyle='#10b981';ctx.lineWidth=2;ctx.stroke();
    // Fill
    const lastX=pad+(pts.length-1)*(W-pad)/(pts.length-1||1);
    ctx.lineTo(lastX,H-pad);ctx.lineTo(pad,H-pad);ctx.closePath();
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'rgba(16,185,129,0.15)');grd.addColorStop(1,'rgba(16,185,129,0)');
    ctx.fillStyle=grd;ctx.fill();
    // Labels
    ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='10px JetBrains Mono';ctx.textAlign='right';
    for(let i=0;i<5;i++){const v=maxV-i*range/4;ctx.fillText('$'+Math.round(v),pad-4,pad+i*(H-2*pad)/4+4);}
}

function drawInstruments(){
    const c=document.getElementById('instCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const byInst={};trades.forEach(t=>{byInst[t.instrument]=(byInst[t.instrument]||0)+t.pnl;});
    const sorted=Object.entries(byInst).sort((a,b)=>b[1]-a[1]);
    const W=c.width,H=c.height,pad=80,barH=18,gap=6;
    const maxAbs=Math.max(...sorted.map(s=>Math.abs(s[1])),1);
    ctx.clearRect(0,0,W,H);
    const midX=pad+(W-pad-60)/2;
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.beginPath();ctx.moveTo(midX,0);ctx.lineTo(midX,H);ctx.stroke();
    sorted.forEach(([inst,pnl],i)=>{
        const y=10+i*(barH+gap);
        const barW=Math.abs(pnl)/maxAbs*(W-pad-60)/2;
        const x=pnl>=0?midX:midX-barW;
        ctx.fillStyle=pnl>=0?'rgba(16,185,129,0.6)':'rgba(239,68,68,0.6)';
        ctx.beginPath();ctx.roundRect(x,y,barW,barH,3);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='11px Inter';ctx.textAlign='right';
        ctx.fillText(inst,pad-8,y+13);
        ctx.textAlign=pnl>=0?'left':'right';ctx.fillStyle=pnl>=0?'#10b981':'#ef4444';
        ctx.font='10px JetBrains Mono';
        ctx.fillText(fmt$(pnl),pnl>=0?midX+barW+6:midX-barW-6,y+13);
    });
}

// ‚ïê‚ïê‚ïê TRADE LOG ‚ïê‚ïê‚ïê
let logSort={col:'date',asc:false};
let logFilter={search:'',inst:'',dir:''};
function renderTradeLog(){
    let filtered=[...trades];
    if(logFilter.search){const q=logFilter.search.toLowerCase();filtered=filtered.filter(t=>`${t.instrument} ${t.tags.join(' ')} ${t.notes}`.toLowerCase().includes(q));}
    if(logFilter.inst)filtered=filtered.filter(t=>t.instrument===logFilter.inst);
    if(logFilter.dir)filtered=filtered.filter(t=>t.direction===logFilter.dir);
    filtered.sort((a,b)=>{let v=0;if(logSort.col==='date')v=new Date(a.date)-new Date(b.date);else if(logSort.col==='pnl')v=a.pnl-b.pnl;else if(logSort.col==='instrument')v=a.instrument.localeCompare(b.instrument);return logSort.asc?v:-v;});

    const insts=[...new Set(trades.map(t=>t.instrument))].sort();
    let h=`<div class="card"><div class="card-title">TRADE LOG</div>
    <div class="filters">
        <input class="flt" placeholder="üîç Search trades..." value="${logFilter.search}" oninput="logFilter.search=this.value;renderTradeLog()"/>
        <select class="flt" onchange="logFilter.inst=this.value;renderTradeLog()"><option value="">All Instruments</option>${insts.map(i=>`<option ${logFilter.inst===i?'selected':''}>${i}</option>`).join('')}</select>
        <select class="flt" onchange="logFilter.dir=this.value;renderTradeLog()"><option value="">All Directions</option><option ${logFilter.dir==='LONG'?'selected':''}>LONG</option><option ${logFilter.dir==='SHORT'?'selected':''}>SHORT</option></select>
        <span style="font-size:11px;color:var(--dim);align-self:center;margin-left:auto">${filtered.length} trades</span>
    </div>
    <div class="tbl-wrap"><table>
    <tr><th onclick="sortLog('date')">Date ${logSort.col==='date'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th onclick="sortLog('instrument')">Instrument ${logSort.col==='instrument'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Size</th><th onclick="sortLog('pnl')">P&L ${logSort.col==='pnl'?(logSort.asc?'‚Üë':'‚Üì'):''}</th><th>Duration</th><th>Tags</th><th>Rating</th></tr>
    ${filtered.map(t=>`<tr>
        <td style="font-family:'JetBrains Mono';font-size:11px">${new Date(t.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
        <td style="font-weight:600">${t.instrument}</td>
        <td class="${t.direction==='LONG'?'dir-long':'dir-short'}">${t.direction}</td>
        <td style="font-family:'JetBrains Mono'">${t.entry}</td>
        <td style="font-family:'JetBrains Mono'">${t.exit}</td>
        <td>${t.size}</td>
        <td style="color:${pnlColor(t.pnl)};font-weight:600;font-family:'JetBrains Mono'">${fmt$(t.pnl)}</td>
        <td>${t.duration}</td>
        <td>${t.tags.map(g=>`<span class="pill-tag">${g}</span>`).join('')}</td>
        <td>${'‚òÖ'.repeat(t.rating)+'‚òÜ'.repeat(5-t.rating)}</td>
    </tr>`).join('')}
    </table></div></div>`;
    document.getElementById('p1').innerHTML=h;
}
function sortLog(col){if(logSort.col===col)logSort.asc=!logSort.asc;else{logSort.col=col;logSort.asc=false;}renderTradeLog();}

// ‚ïê‚ïê‚ïê ADD TRADE ‚ïê‚ïê‚ïê
let addMode='manual',addDir='LONG',addTags=new Set(),addEmo='',addRating=0;
function renderAddTrade(){
    let h=`<div class="mode-toggle">
        <button class="mt-btn ${addMode==='manual'?'on':''}" onclick="addMode='manual';renderAddTrade()">‚úèÔ∏è Manual Entry</button>
        <button class="mt-btn ${addMode==='broker'?'on':''}" onclick="addMode='broker';renderAddTrade()">üîå Connect Broker</button>
    </div>`;
    if(addMode==='manual'){
        h+=`<div class="card"><div class="card-title">LOG A NEW TRADE</div>
        <div class="form-grid">
            <div class="form-group"><label>Instrument</label><select id="f-inst">${INSTRUMENTS.map(i=>`<option>${i}</option>`).join('')}</select></div>
            <div class="form-group"><label>Direction</label><div class="dir-toggle"><button class="dir-btn long ${addDir==='LONG'?'sel':''}" onclick="addDir='LONG';renderAddTrade()">‚ñ≤ LONG</button><button class="dir-btn short ${addDir==='SHORT'?'sel':''}" onclick="addDir='SHORT';renderAddTrade()">‚ñº SHORT</button></div></div>
            <div class="form-group"><label>Entry Date & Time</label><input type="datetime-local" id="f-edate" value="${new Date().toISOString().slice(0,16)}"/></div>
            <div class="form-group"><label>Exit Date & Time</label><input type="datetime-local" id="f-xdate" value="${new Date().toISOString().slice(0,16)}"/></div>
            <div class="form-group"><label>Entry Price</label><input type="number" step="any" id="f-ep" placeholder="0.00" oninput="calcPnl()"/></div>
            <div class="form-group"><label>Exit Price</label><input type="number" step="any" id="f-xp" placeholder="0.00" oninput="calcPnl()"/></div>
            <div class="form-group"><label>Position Size / Lots</label><input type="number" step="any" id="f-size" placeholder="1.0" value="1" oninput="calcPnl()"/></div>
            <div class="form-group"><label>Notes</label><textarea id="f-notes" placeholder="What was your thesis? What did you learn?"></textarea></div>
        </div>
        <div class="auto-calc">
            <div class="ac-item"><div class="ac-val" id="ac-pnl" style="color:var(--dim)">$0</div><div class="ac-lbl">P&L</div></div>
            <div class="ac-item"><div class="ac-val" id="ac-pct" style="color:var(--dim)">0%</div><div class="ac-lbl">P&L %</div></div>
            <div class="ac-item"><div class="ac-val" id="ac-rr" style="color:var(--dim)">‚Äî</div><div class="ac-lbl">R:R</div></div>
            <div class="ac-item"><div class="ac-val" id="ac-dur" style="color:var(--dim)">‚Äî</div><div class="ac-lbl">Duration</div></div>
        </div>
        <div style="margin-bottom:12px"><label style="font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:6px">Tags</label><div class="tags-row">${TAGS.map(t=>`<button class="tag-btn ${addTags.has(t)?'sel':''}" onclick="addTags.has('${t}')?addTags.delete('${t}'):addTags.add('${t}');renderAddTrade()">${t}</button>`).join('')}</div></div>
        <div style="display:flex;gap:24px;margin-bottom:12px">
            <div><label style="font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:6px">Emotion</label><div class="emotions">${EMOTIONS.map(e=>`<button class="emo-btn ${addEmo===e?'sel':''}" onclick="addEmo='${e}';renderAddTrade()">${e}</button>`).join('')}</div></div>
            <div><label style="font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:6px">Plan Rating</label><div class="stars">${[1,2,3,4,5].map(i=>`<button class="star ${i<=addRating?'lit':''}" onclick="addRating=${i};renderAddTrade()">‚òÖ</button>`).join('')}</div></div>
        </div>
        <button class="save-btn" onclick="saveTrade()">üíæ Save Trade</button>
        </div>`;
    } else {
        h+=`<div class="card"><div class="card-title">CONNECT YOUR BROKER</div>
        <p style="font-size:13px;color:var(--dim);margin-bottom:16px">Auto-import your trades from supported brokers</p>
        <div class="broker-grid">
            ${[{n:'MetaTrader 4',i:'üìä'},{n:'MetaTrader 5',i:'üìà'},{n:'cTrader',i:'‚ö°'},{n:'Interactive Brokers',i:'üè¶'},{n:'TradingView',i:'üì∫'}].map(b=>`
                <div class="card broker-card" onclick="document.getElementById('modalBg').classList.add('show')">
                    <div class="b-icon">${b.i}</div>
                    <div class="b-name">${b.n}</div>
                    <div class="b-status">Not connected</div>
                    <button class="connect-btn">Connect</button>
                </div>
            `).join('')}
        </div></div>`;
    }
    document.getElementById('p2').innerHTML=h;
}

function calcPnl(){
    const ep=+document.getElementById('f-ep')?.value||0;
    const xp=+document.getElementById('f-xp')?.value||0;
    const sz=+document.getElementById('f-size')?.value||1;
    const ed=document.getElementById('f-edate')?.value;
    const xd=document.getElementById('f-xdate')?.value;
    if(!ep)return;
    const diff=addDir==='LONG'?xp-ep:ep-xp;
    const pnl=Math.round(diff*sz*100);
    const pct=ep?(diff/ep*100).toFixed(2):0;
    const el=id=>document.getElementById(id);
    if(el('ac-pnl')){el('ac-pnl').textContent=fmt$(pnl);el('ac-pnl').style.color=pnlColor(pnl);}
    if(el('ac-pct')){el('ac-pct').textContent=(pct>=0?'+':'')+pct+'%';el('ac-pct').style.color=pnlColor(pnl);}
    if(ed&&xd){const h=Math.round((new Date(xd)-new Date(ed))/3600000);el('ac-dur').textContent=h>0?h+'h':'‚Äî';}
}

function saveTrade(){
    const inst=document.getElementById('f-inst').value;
    const ep=+document.getElementById('f-ep').value;
    const xp=+document.getElementById('f-xp').value;
    const sz=+document.getElementById('f-size').value;
    if(!ep||!xp){toast('‚ö†Ô∏è Enter entry and exit prices');return;}
    const diff=addDir==='LONG'?xp-ep:ep-xp;
    const pnl=Math.round(diff*sz*100);
    const ed=document.getElementById('f-edate').value;
    const xd=document.getElementById('f-xdate').value;
    const durH=Math.round((new Date(xd)-new Date(ed))/3600000);
    const t={
        id:Date.now(),date:ed,instrument:inst,direction:addDir,entry:ep,exit:xp,size:sz,
        pnl,pnlPct:+(diff/ep*100).toFixed(2),duration:durH+'h',
        tags:[...addTags],notes:document.getElementById('f-notes').value,
        emotion:addEmo,rating:addRating
    };
    trades.unshift(t);saveTrades(trades);
    addTags.clear();addEmo='';addRating=0;
    toast('‚úÖ Trade saved!');
    renderAddTrade();
}

// ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
let calMonth=1,calYear=2026;
function renderCalendar(){
    const dailyPnl={};
    trades.forEach(t=>{
        const d=new Date(t.date);
        const key=d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
        if(!dailyPnl[key])dailyPnl[key]={pnl:0,cnt:0};
        dailyPnl[key].pnl+=t.pnl;dailyPnl[key].cnt++;
    });
    const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
    const first=new Date(calYear,calMonth,1);
    const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
    const startDay=first.getDay();
    const today=new Date();

    let h=`<div class="card">
    <div class="cal-nav">
        <button onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar()">‚Üê Prev</button>
        <div class="month">${months[calMonth]} ${calYear}</div>
        <button onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar()">Next ‚Üí</button>
    </div>
    <div class="cal-grid">
        ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="cal-hdr">${d}</div>`).join('')}`;
    for(let i=0;i<startDay;i++)h+=`<div class="cal-day empty"></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const key=calYear+'-'+(calMonth+1)+'-'+d;
        const data=dailyPnl[key];
        const isToday=today.getDate()===d&&today.getMonth()===calMonth&&today.getFullYear()===calYear;
        let bg='transparent';
        if(data){
            const intensity=Math.min(Math.abs(data.pnl)/1500,1);
            bg=data.pnl>=0?`rgba(16,185,129,${0.05+intensity*0.2})`:`rgba(239,68,68,${0.05+intensity*0.2})`;
        }
        h+=`<div class="cal-day${isToday?' today':''}" style="background:${bg}">
            <div class="d-num">${d}</div>
            ${data?`<div class="d-pnl" style="color:${pnlColor(data.pnl)}">${fmt$(data.pnl)}</div><div class="d-cnt">${data.cnt} trade${data.cnt>1?'s':''}</div>`:''}
        </div>`;
    }
    h+=`</div></div>`;
    document.getElementById('p3').innerHTML=h;
}

// ‚ïê‚ïê‚ïê ANALYTICS ‚ïê‚ïê‚ïê
function renderAnalytics(){
    const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<=0);
    // Streaks
    let curWin=0,maxWin=0,curLoss=0,maxLoss=0;
    [...trades].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t=>{
        if(t.pnl>0){curWin++;curLoss=0;maxWin=Math.max(maxWin,curWin);}
        else{curLoss++;curWin=0;maxLoss=Math.max(maxLoss,curLoss);}
    });

    let h=`<div class="streak-row">
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${curWin}</div><div class="s-lbl">Current Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--grn)">${maxWin}</div><div class="s-lbl">Max Win Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${curLoss}</div><div class="s-lbl">Current Loss Streak</div></div>
        <div class="card streak"><div class="s-val" style="color:var(--red)">${maxLoss}</div><div class="s-lbl">Max Loss Streak</div></div>
    </div>`;
    h+=`<div class="ana-grid">
        <div class="card"><div class="card-title">WIN / LOSS DISTRIBUTION</div><canvas id="wlCanvas" height="220"></canvas></div>
        <div class="card"><div class="card-title">P&L DISTRIBUTION</div><canvas id="pnlDistCanvas" height="220"></canvas></div>
    </div>`;
    h+=`<div class="ana-grid">
        <div class="card"><div class="card-title">PERFORMANCE BY DAY</div><canvas id="dayCanvas" height="200"></canvas></div>
        <div class="card"><div class="card-title">PERFORMANCE BY SESSION</div><canvas id="sessCanvas" height="200"></canvas></div>
    </div>`;
    document.getElementById('p4').innerHTML=h;
    setTimeout(()=>{drawDonut(wins.length,losses.length);drawPnlDist();drawByDay();drawBySession();},50);
}

function drawDonut(w,l){
    const c=document.getElementById('wlCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const cx=c.width/2,cy=c.height/2+10,r=70;
    const total=w+l||1;
    // Win arc
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+w/total*Math.PI*2);ctx.lineWidth=24;ctx.strokeStyle='#10b981';ctx.stroke();
    // Loss arc
    ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2+w/total*Math.PI*2,-Math.PI/2+Math.PI*2);ctx.lineWidth=24;ctx.strokeStyle='#ef4444';ctx.stroke();
    // Center text
    ctx.fillStyle='#e8e8ed';ctx.font='bold 22px JetBrains Mono';ctx.textAlign='center';ctx.fillText((w/total*100).toFixed(0)+'%',cx,cy+2);
    ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='11px Inter';ctx.fillText('Win Rate',cx,cy+20);
    // Legend
    ctx.fillStyle='#10b981';ctx.fillRect(cx-60,cy+40,10,10);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='11px Inter';ctx.textAlign='left';ctx.fillText(`Wins: ${w}`,cx-44,cy+49);
    ctx.fillStyle='#ef4444';ctx.fillRect(cx+10,cy+40,10,10);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fillText(`Losses: ${l}`,cx+26,cy+49);
}

function drawPnlDist(){
    const c=document.getElementById('pnlDistCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const buckets=[{l:'<-500',min:-Infinity,max:-500},{l:'-500 to -200',min:-500,max:-200},{l:'-200 to 0',min:-200,max:0},{l:'0 to 200',min:0,max:200},{l:'200 to 500',min:200,max:500},{l:'>500',min:500,max:Infinity}];
    const counts=buckets.map(b=>trades.filter(t=>t.pnl>=b.min&&t.pnl<b.max).length);
    const maxC=Math.max(...counts,1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/buckets.length-8;
    buckets.forEach((b,i)=>{
        const x=pad+i*(barW+8);
        const h=counts[i]/maxC*(H-pad-30);
        const color=b.max<=0?'rgba(239,68,68,0.6)':'rgba(16,185,129,0.6)';
        ctx.fillStyle=color;ctx.beginPath();ctx.roundRect(x,H-pad-h,barW,h,3);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px Inter';ctx.textAlign='center';
        ctx.fillText(b.l,x+barW/2,H-pad+14);
        if(counts[i])ctx.fillText(counts[i],x+barW/2,H-pad-h-6);
    });
}

function drawByDay(){
    const c=document.getElementById('dayCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const byDay=Array(7).fill(null).map(()=>({sum:0,cnt:0}));
    trades.forEach(t=>{const d=new Date(t.date).getDay();byDay[d].sum+=t.pnl;byDay[d].cnt++;});
    const avgs=byDay.map(d=>d.cnt?d.sum/d.cnt:0);
    const maxA=Math.max(...avgs.map(Math.abs),1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/7-10,midY=H/2;
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W,midY);ctx.stroke();
    avgs.forEach((v,i)=>{
        const x=pad+i*(barW+10);
        const h=Math.abs(v)/maxA*(H/2-30);
        ctx.fillStyle=v>=0?'rgba(16,185,129,0.6)':'rgba(239,68,68,0.6)';
        ctx.beginPath();ctx.roundRect(x,v>=0?midY-h:midY,barW,h,3);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='10px Inter';ctx.textAlign='center';
        ctx.fillText(days[i],x+barW/2,H-8);
        if(v)ctx.fillText(fmt$(Math.round(v)),x+barW/2,v>=0?midY-h-6:midY+h+14);
    });
}

function drawBySession(){
    const c=document.getElementById('sessCanvas');if(!c)return;
    const ctx=c.getContext('2d');c.width=c.parentElement.clientWidth-32;
    const sessions=[{n:'Asian',h:[0,8]},{n:'London',h:[8,16]},{n:'New York',h:[13,21]}];
    const data=sessions.map(s=>{
        const t=trades.filter(tr=>{const h=new Date(tr.date).getHours();return h>=s.h[0]&&h<s.h[1];});
        return{name:s.n,pnl:t.reduce((a,x)=>a+x.pnl,0),cnt:t.length};
    });
    const maxP=Math.max(...data.map(d=>Math.abs(d.pnl)),1);
    const W=c.width,H=c.height,pad=40,barW=(W-pad-20)/3-20,midY=H/2;
    ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.beginPath();ctx.moveTo(pad,midY);ctx.lineTo(W,midY);ctx.stroke();
    data.forEach((d,i)=>{
        const x=pad+i*(barW+20);
        const h=Math.abs(d.pnl)/maxP*(H/2-30);
        ctx.fillStyle=d.pnl>=0?'rgba(16,185,129,0.6)':'rgba(239,68,68,0.6)';
        ctx.beginPath();ctx.roundRect(x,d.pnl>=0?midY-h:midY,barW,h,4);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='11px Inter';ctx.textAlign='center';
        ctx.fillText(d.name,x+barW/2,H-8);
        ctx.fillText(fmt$(d.pnl),x+barW/2,d.pnl>=0?midY-h-8:midY+h+16);
        ctx.fillStyle='rgba(255,255,255,0.2)';ctx.font='9px Inter';ctx.fillText(d.cnt+' trades',x+barW/2,H-20);
    });
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
renderDashboard();
</script>
</body>
</html>
